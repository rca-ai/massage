<!doctype html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마사지샵 관리 시스템 (Supabase DB 연동)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&amp;family=Noto+Sans+Thai:wght@300;400;500;700&amp;family=Noto+Sans+Vietnamese:wght@300;400;500;700&amp;family=Roboto:wght@300;400;500;700&amp;family=Nanum+Gothic:wght@400;700;800&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
        .remaining-time {
            font-size: 2rem;
            font-weight: bold;
            color: #ef4444;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            max-height: 90%;
            overflow-y: auto;
        }
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .menu-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .duration-selection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .selection-item {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .selection-item:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .selection-item.selected {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .edit-row {
            background-color: #f3f4f6;
        }
        .selected-staff-info {
            background-color: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .menu-row {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .required-label::after {
            content: " *";
            color: red;
            font-weight: bold;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="bg-gray-100 min-h-full"><div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
   <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
    <div class="text-center mb-8">
     <h1 class="text-3xl font-bold text-gray-800" data-translate="title">마사지샵 관리 시스템</h1>
     <div class="w-20 h-1 bg-blue-500 mx-auto"></div>
    </div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">언어 선택 / Language / ภาษา / Ngôn ngữ</label>
     <div class="grid grid-cols-4 gap-2"><button onclick="setLanguage('ko')" class="bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600" id="langKo">한국어</button> <button onclick="setLanguage('en')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langEn">English</button> <button onclick="setLanguage('th')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langTh">ไทย</button> <button onclick="setLanguage('vi')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langVi">Tiếng Việt</button>
     </div>
    </div>
    <div class="space-y-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-2" data-translate="username">아이디 (이메일)</label> <input type="text" id="loginUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="usernameInput" placeholder="Supabase 인증 이메일">
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2" data-translate="password">비밀번호</label> <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="passwordInput" placeholder="Supabase 인증 비밀번호">
     </div><button onclick="processLogin()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200" data-translate="login">로그인</button>
    </div>
   </div>
  </div><div id="mainScreen" class="container mx-auto p-6" style="display: none;"><div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
     <div>
      <h1 class="text-3xl font-bold text-gray-800" data-translate="title">마사지 관리 프로그램</h1>
      <p id="shopName" class="text-lg text-gray-600 mt-1">Supabase DB 연동 화면</p>
     </div>
     <div class="flex gap-2"><button onclick="showLanguageModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="changeLanguage">언어 변경</button> <button onclick="showFontModal()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600" data-translate="changeFont">폰트 변경</button> <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" data-translate="logout">로그아웃</button>
     </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
     <div class="text-center"><label class="block text-sm font-medium mb-2" data-translate="todayDate">오늘 날짜</label>
      <div class="flex gap-2"><input type="date" id="currentDate" class="border rounded px-3 py-2 flex-1"> <button onclick="confirmDateChange()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="confirmDate">확인</button>
      </div>
     </div>
     <div class="text-center"><label class="block text-sm font-medium mb-2" data-translate="currentTime">현재 시간</label>
      <div id="currentTime" class="text-xl font-bold text-blue-600"></div>
     </div>
    </div>
   </div><div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"><button onclick="showDashboard()" class="bg-blue-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-blue-600" data-translate="dashboard">현황판</button> <button onclick="showOrder()" class="bg-indigo-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-indigo-600" data-translate="order">순번</button> <button onclick="showReservation()" class="bg-green-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-green-600" data-translate="reservation">예약</button> <button onclick="showStatistics()" class="bg-purple-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-purple-600" data-translate="statistics">통계</button> <button onclick="showDBManagement()" class="bg-orange-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-orange-600" data-translate="dbManagement">DB 관리</button>
   </div><div id="orderSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="orderManagement">순번 관리</h2>
    <div class="mb-4"><button onclick="saveStaffOrder()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="saveOrder">순번 저장</button>
    </div>
    <div class="overflow-x-auto">
     <table class="w-full border-collapse border border-gray-300">
      <thead>
       <tr class="bg-gray-100">
        <th class="border border-gray-300 p-2" data-translate="staffName">직원명</th>
        <th class="border border-gray-300 p-2" data-translate="status">상태</th>
        <th class="border border-gray-300 p-2" data-translate="orderNumber">순번</th>
       </tr>
      </thead>
      <tbody id="orderTable">
      </tbody>
     </table>
    </div>
    <div class="mt-4 text-sm text-gray-600" data-translate="orderZeroVacationNote">
     * 순번 0은 휴가로 처리됩니다.
    </div>
   </div><div id="dashboardSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="dashboard">현황판</h2>
    <div class="overflow-x-auto">
     <table class="w-full border-collapse border border-gray-300">
      <thead>
       <tr class="bg-gray-100">
        <th class="border border-gray-300 p-2" data-translate="staff">직원명</th>
        <th class="border border-gray-300 p-2" data-translate="menu">메뉴</th>
        <th class="border border-gray-300 p-2" data-translate="duration">시간</th>
        <th class="border border-gray-300 p-2" data-translate="startTime">시작시간</th>
        <th class="border border-gray-300 p-2" data-translate="endTime">끝시간</th>
        <th class="border border-gray-300 p-2" data-translate="remainingTime">남은시간</th>
        <th class="border border-gray-300 p-2" data-translate="price">가격</th>
        <th class="border border-gray-300 p-2" data-translate="commission">커미션</th>
        <th class="border border-gray-300 p-2" data-translate="roomNumber">방번호</th>
        <th class="border border-gray-300 p-2" data-translate="actions">작업</th>
       </tr>
      </thead>
      <tbody id="dashboardTable">
      </tbody>
     </table>
    </div>
   </div><div id="reservationSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="reservation">예약</h2><div class="mb-6"><label class="block text-sm font-medium mb-2 required-label" data-translate="selectStaff">직원 선택</label>
     <div id="staffSelectionContainer">
      <div id="staffSelection" class="selection-grid"></div>
      <div id="selectedStaffInfo" class="selected-staff-info" style="display: none;">
       <div class="flex justify-between items-center">
        <div>
         <h4 class="font-bold text-lg">선택된 직원: <span id="selectedStaffName"></span></h4>
         <p class="text-sm text-gray-600">순번: <span id="selectedStaffOrder"></span></p>
        </div><button onclick="changeStaff()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">직원 변경</button>
       </div>
      </div>
     </div>
    </div><div id="menuListContainer" style="display: none;">
     <div class="flex justify-between items-center mb-4"><label class="block text-sm font-medium required-label">메뉴 목록</label> <button onclick="addMenuRow()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center gap-2"> <span class="text-lg">+</span> 메뉴 추가 </button>
     </div>
     <div id="menuRows"></div><div class="mt-6 p-4 bg-gray-100 rounded">
      <div class="grid grid-cols-2 gap-4">
       <div>
        <strong data-translate="totalPrice">총 가격:</strong> <span id="totalPrice">0</span><span id="totalPriceCurrency"></span>
       </div>
       <div>
        <strong data-translate="totalCommission">총 커미션:</strong> <span id="totalCommission">0</span><span id="totalCommissionCurrency"></span>
       </div>
      </div>
     </div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div><label class="block text-sm font-medium mb-2" data-translate="startTime">시작 시간 (선택사항)</label> <input type="time" id="reservationStartTime" class="w-full border rounded px-3 py-2" onchange="updateAllMenuTimes()">
      </div>
      <div><label class="block text-sm font-medium mb-2" data-translate="roomNumber">방번호 (선택사항)</label> <select id="reservationRoom" class="w-full border rounded px-3 py-2"> <option value="" data-translate="selectRoom">방 선택</option> </select>
      </div>
      <div><label class="block text-sm font-medium mb-2" data-translate="customerName">고객명 (선택사항)</label> <input type="text" id="reservationCustomer" class="w-full border rounded px-3 py-2" data-translate-placeholder="enterCustomerName">
      </div>
     </div><div id="menuTimeSettings" class="mt-6" style="display: none;">
      <h4 class="font-bold mb-3">메뉴별 시간 설정</h4>
      <div id="menuTimeList" class="space-y-3">
      </div>
     </div><button onclick="addReservation()" class="mt-6 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600" data-translate="addReservation">예약 추가</button>
    </div>
   </div><div id="statisticsSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="statistics">통계</h2>
    <div class="mb-4 flex gap-4 flex-wrap"><button onclick="showDailyStats()" id="dailyStatsBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="daily">일간</button> <button onclick="showWeeklyStats()" id="weeklyStatsBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400" data-translate="weekly">주간</button> <button onclick="showMonthlyStats()" id="monthlyStatsBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400" data-translate="monthly">월간</button> <button onclick="showMenuSales()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600" data-translate="monthlyMenuSales">월간 메뉴 매출</button> <button onclick="showMonthlySalesChart()" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600" data-translate="monthlySalesChart">월간 매출 그래프</button> <button onclick="downloadExcel()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" data-translate="download">다운로드</button>
    </div><div class="mb-6 p-4 bg-gray-50 rounded"><div id="dailyDateSelection" class="mb-4"><label class="block text-sm font-medium mb-2" data-translate="selectDate">날짜 선택</label> <input type="date" id="statsDate" class="border rounded px-3 py-2" onchange="updateStats()">
     </div><div id="rangeDateSelection" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display: none;">
      <div><label class="block text-sm font-medium mb-2" data-translate="startDate">시작 날짜</label> <input type="date" id="statsStartDate" class="w-full border rounded px-3 py-2" onchange="autoSetEndDate()">
      </div>
      <div><label class="block text-sm font-medium mb-2" data-translate="endDate">끝 날짜</label> <input type="date" id="statsEndDate" class="w-full border rounded px-3 py-2" onchange="updateStats()">
      </div>
     </div><div id="quickDateSelection" class="mt-3 flex gap-2 flex-wrap" style="display: none;"><button onclick="setThisWeek()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200" data-translate="thisWeek">이번 주</button> <button onclick="setLastWeek()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200" data-translate="lastWeek">지난 주</button> <button onclick="setThisMonth()" class="bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200" data-translate="thisMonth">이번 달</button> <button onclick="setLastMonth()" class="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200" data-translate="lastMonth">지난 달</button>
     </div>
    </div><div id="chartContainer" class="mb-6" style="display: none;">
     <canvas id="statsChart" width="800" height="400"></canvas>
    </div><div class="mb-6">
     <h3 class="text-lg font-bold mb-2" data-translate="staffStatisticsTitle">직원별 통계</h3>
     <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300">
       <thead>
        <tr class="bg-gray-100">
         <th class="border border-gray-300 p-2" data-translate="staff">마사지사</th>
         <th class="border border-gray-300 p-2" data-translate="totalPrice">총 가격</th>
         <th class="border border-gray-300 p-2" data-translate="totalCommission">총 커미션</th>
        </tr>
       </thead>
       <tbody id="statsTable">
       </tbody>
      </table>
     </div>
    </div><div class="mb-6">
     <h3 class="text-lg font-bold mb-2" data-translate="paymentMethodStatisticsTitle">입금방식별 통계</h3>
     <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300">
       <thead>
        <tr class="bg-gray-100">
         <th class="border border-gray-300 p-2" data-translate="paymentMethodColumn">입금방식</th>
         <th class="border border-gray-300 p-2" data-translate="amountColumn">금액</th>
        </tr>
       </thead>
       <tbody id="paymentStatsTable">
       </tbody>
      </table>
     </div>
    </div>
    <div class="p-4 bg-gray-100 rounded">
     <div class="grid grid-cols-3 gap-4">
      <div>
       <strong data-translate="grandTotal">총 금액(QR팁 제외):</strong> <span id="grandTotalPrice">0</span><span id="grandTotalCurrency"></span>
      </div>
      <div>
       <strong data-translate="grandTotalCommission">총 커미션:</strong> <span id="grandTotalCommission">0</span><span id="grandTotalCommissionCurrency"></span>
      </div>
      <div>
       <strong data-translate="profit">수익:</strong> <span id="totalProfit">0</span><span id="totalProfitCurrency"></span>
      </div>
     </div>
    </div>
   </div><div id="dbManagementSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="dbManagement">DB 관리</h2><div class="mb-6 p-4 bg-gray-100 rounded">
     <h3 class="text-lg font-bold mb-2" data-translate="dataBackupRestoreTitle">데이터 백업 및 복원</h3>
     <div class="grid grid-cols-2 gap-4">
      <div>
       <h4 class="font-semibold mb-2" data-translate="backupButton">백업</h4>
       <div class="flex gap-2 flex-wrap"><button onclick="showLocalBackupDialog()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm" data-translate="localBackupButton">로컬 백업</button> <button onclick="showGoogleBackupDialog()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" data-translate="googleBackupButton">구글 백업</button>
       </div>
      </div>
      <div>
       <h4 class="font-semibold mb-2" data-translate="restoreButton">복원</h4>
       <div class="flex gap-2 flex-wrap"><input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)"> <button onclick="showLocalRestoreDialog()" class="bg-orange-600 text-white px-3 py-2 rounded hover:bg-orange-700 text-sm" data-translate="localRestoreButton">로컬 복원</button> <button onclick="showGoogleRestoreDialog()" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm" data-translate="googleRestoreButton">구글 복원</button>
       </div>
      </div>
     </div>
     <div class="mt-4"><button onclick="exportAllDataExcel()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700" data-translate="exportAllDataButton">전체 데이터 엑셀 내보내기</button>
     </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4"><button onclick="manageMenus()" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600" data-translate="menuManagement">메뉴 관리</button> <button onclick="manageStaff()" class="bg-green-500 text-white py-3 px-4 rounded hover:bg-green-600" data-translate="staffManagement">직원 관리</button> <button onclick="manageRooms()" class="bg-purple-500 text-white py-3 px-4 rounded hover:bg-purple-600" data-translate="roomManagement">방 관리</button> <button onclick="manageCustomers()" class="bg-orange-500 text-white py-3 px-4 rounded hover:bg-orange-600" data-translate="customerManagement">고객 관리</button> <button onclick="manageCurrency()" class="bg-pink-500 text-white py-3 px-4 rounded hover:bg-pink-600" data-translate="currencyManagement">화폐 단위</button> <button onclick="managePaymentMethods()" class="bg-yellow-500 text-white py-3 px-4 rounded hover:bg-yellow-600" data-translate="paymentMethodManagement">입금방식 관리</button> <button onclick="manageGuarantee()" class="bg-teal-500 text-white py-3 px-4 rounded hover:bg-teal-600">Guarantee 관리</button>
     <div id="superAdminButtons" style="display: block;"><button onclick="manageAdmins()" class="bg-red-500 text-white py-3 px-4 rounded hover:bg-red-600" data-translate="adminManagement">관리자 관리</button>
     </div>
    </div>
   </div>
  </div><div id="paymentModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4" data-translate="payment">입금 처리</h3>
    <div id="paymentMethods" class="space-y-4 mb-4">
    </div>
    <div class="mb-4"><strong data-translate="totalAmount">총 금액:</strong> <span id="paymentTotalAmount">0</span><span id="paymentCurrency"></span>
    </div>
    <div class="mb-4"><strong data-translate="enteredAmount">입력된 금액:</strong> <span id="paymentEnteredAmount">0</span><span id="paymentEnteredCurrency"></span>
    </div>
    <div class="flex gap-2"><button onclick="processPayment()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-translate="confirm">확인</button> <button onclick="closePaymentModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="cancel">취소</button>
    </div>
   </div>
  </div><div id="managementModal" class="modal">
   <div class="modal-content">
    <h3 id="managementTitle" class="text-xl font-bold mb-4"></h3>
    <div id="managementContent"></div><button onclick="closeManagementModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="close">닫기</button>
   </div>
  </div><div id="languageModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">언어 선택 / Language / ภาษา / Ngôn ngữ</h3>
    <div class="grid grid-cols-2 gap-4"><button onclick="setLanguageAndClose('ko')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">한국어</button> <button onclick="setLanguageAndClose('en')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">English</button> <button onclick="setLanguageAndClose('th')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">ไทย</button> <button onclick="setLanguageAndClose('vi')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">Tiếng Việt</button>
    </div><button onclick="closeLanguageModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">닫기</button>
   </div>
  </div><div id="fontModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4" data-translate="fontSelection">폰트 선택</h3><div class="mb-6 p-4 bg-gray-50 rounded">
     <h4 class="font-bold mb-3" data-translate="fontSize">폰트 크기</h4>
     <div class="grid grid-cols-5 gap-2"><button onclick="setFontSize('small')" id="fontSizeSmall" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeSmall">작게</button> <button onclick="setFontSize('normal')" id="fontSizeNormal" class="bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600" data-translate="fontSizeNormal">보통</button> <button onclick="setFontSize('large')" id="fontSizeLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeLarge">크게</button> <button onclick="setFontSize('xlarge')" id="fontSizeXLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeXLarge">매우 크게</button> <button onclick="setFontSize('xxlarge')" id="fontSizeXXLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeXXLarge">최대</button>
     </div>
     <div class="mt-2 text-sm text-gray-600" data-translate="fontSizePreview"><span id="fontSizePreview">미리보기 텍스트 - Preview Text - ตัวอย่างข้อความ - Văn bản xem trước</span>
     </div>
    </div><div class="mb-4">
     <h4 class="font-bold mb-3" data-translate="fontFamily">폰트 종류</h4>
     <div class="grid grid-cols-1 gap-3"><button onclick="setFontFamily('Arial')" id="fontFamilyArial" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600" style="font-family: Arial;">Arial (기본)</button> <button onclick="setFontFamily('Noto Sans KR')" id="fontFamilyNotoKR" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans KR', sans-serif;">Noto Sans KR (한글 최적화)</button> <button onclick="setFontFamily('Malgun Gothic')" id="fontFamilyMalgun" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Malgun Gothic', sans-serif;">맑은 고딕</button> <button onclick="setFontFamily('Nanum Gothic')" id="fontFamilyNanum" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Nanum Gothic', sans-serif;">나눔고딕</button> <button onclick="setFontFamily('Roboto')" id="fontFamilyRoboto" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Roboto', sans-serif;">Roboto (영문 최적화)</button> <button onclick="setFontFamily('Noto Sans Thai')" id="fontFamilyThai" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans Thai', sans-serif;">Noto Sans Thai (태국어)</button> <button onclick="setFontFamily('Noto Sans Vietnamese')" id="fontFamilyVietnamese" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans Vietnamese', sans-serif;">Noto Sans Vietnamese (베트남어)</button>
     </div>
    </div>
    <div class="flex gap-2"><button onclick="applyFontSettings()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-translate="apply">적용</button> <button onclick="closeFontModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="close">닫기</button>
    </div>
   </div>
  </div><div id="googleLoginModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">구글 계정 로그인</h3>
    <div class="space-y-4">
     <div><label class="block text-sm font-medium mb-2">구글 이메일:</label> <input type="email" id="googleEmail" class="w-full border rounded px-3 py-2" placeholder="example@gmail.com">
     </div>
     <div><label class="block text-sm font-medium mb-2">구글 비밀번호:</label> <input type="password" id="googlePassword" class="w-full border rounded px-3 py-2" placeholder="비밀번호 입력">
     </div>
     <div class="text-sm text-gray-600">
      * 실제 구글 계정 정보를 입력하세요. 백업/복원을 위해 구글 드라이브에 접근합니다.
     </div>
    </div>
    <div class="flex gap-2 mt-4"><button id="googleLoginConfirm" onclick="processGoogleLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">로그인</button> <button onclick="closeGoogleLoginModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">취소</button>
    </div>
   </div>
  </div>
  <script>
        // =========================================================================
        // 1. Supabase 클라이언트 초기화 및 연결
        // =========================================================================
        const SUPABASE_URL = 'https://requjozkxlxomoamdrrf.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJlcXVqb3preGx4b21vYW1kcnJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzMDM1NjYsImV4cCI6MjA3ODg3OTU2Nn0.LpZyM2K12EShRAZyptk6Ak2XDkxQ-WuUPklTZfqt_Tg';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase Client Initialized!');

        // =========================================================================
        // 2. 전역 변수 및 번역 (Translation)
        // =========================================================================
        let currentLanguage = 'ko';
        let currentFont = 'Arial';
        let currentFontSize = 'normal';
        let selectedFontFamily = 'Arial';
        let selectedFontSize = 'normal';
        let currentAdmin = null;
        let currentPaymentReservationId = null;
        let selectedStaff = null;
        let menuRowCounter = 0;
        let menuRows = [];
        let currency = { symbol: '₩', name: '원' };

        // [최소한의 필수 번역 데이터]
        const translations = {
            ko: {
                title: '마사지샵 관리 시스템', username: '아이디 (이메일)', password: '비밀번호', login: '로그인', usernameInput: 'Supabase 인증 이메일', passwordInput: 'Supabase 인증 비밀번호',
                changeLanguage: '언어 변경', changeFont: '폰트 변경', logout: '로그아웃',
                todayDate: '오늘 날짜', currentTime: '현재 시간', confirmDate: '확인',
                dashboard: '현황판', order: '순번', reservation: '예약', statistics: '통계', dbManagement: 'DB 관리',
                orderManagement: '순번 관리', saveOrder: '순번 저장', staffName: '직원명', status: '상태', orderNumber: '순번', orderZeroVacationNote: '* 순번 0은 휴가로 처리됩니다.',
                staff: '직원명', menu: '메뉴', duration: '시간', startTime: '시작시간', endTime: '끝시간', remainingTime: '남은시간', price: '가격', commission: '커미션', roomNumber: '방번호', actions: '작업',
                paymentCompleteStatus: '입금 완료', edit: '수정', payment: '입금', delete: '삭제',
                selectStaff: '직원 선택', selectRoom: '방 선택', customerName: '고객명 (선택사항)', enterCustomerName: '고객명 입력', addReservation: '예약 추가',
                totalPrice: '총 가격', totalCommission: '총 커미션',
                payment: '입금 처리', totalAmount: '총 금액', enteredAmount: '입력된 금액', confirm: '확인', cancel: '취소', close: '닫기',
                menuManagement: '메뉴 관리', staffManagement: '직원 관리', roomManagement: '방 관리', currencyManagement: '화폐 단위', paymentMethodManagement: '입금방식 관리', customerManagement: '고객 관리', adminManagement: '관리자 관리',
                daily: '일간', weekly: '주간', monthly: '월간', monthlyMenuSales: '월간 메뉴 매출', monthlySalesChart: '월간 매출 그래프', download: '다운로드',
                selectDate: '날짜 선택', startDate: '시작 날짜', endDate: '끝 날짜', thisWeek: '이번 주', lastWeek: '지난 주', thisMonth: '이번 달', lastMonth: '지난 달',
                staffStatisticsTitle: '직원별 통계', paymentMethodStatisticsTitle: '입금방식별 통계', paymentMethodColumn: '입금방식', amountColumn: '금액', grandTotal: '총 금액(QR팁 제외)', grandTotalCommission: '총 커미션', profit: '수익',
                vacationStatus: '휴가',
                // Management specific
                add: '추가', save: '저장', update: '업데이트', newStaff: '새 직원', phone: '전화번호', bank: '은행', account: '계좌번호',
                menuName: '메뉴 이름', priceTime: '가격/커미션', durationTime: '시간',
                roomNumberLabel: '방 번호', capacity: '수용 인원',
                currencySymbol: '화폐 기호', currencyName: '화폐 이름',
                paymentMethodName: '입금방식 이름',
                guaranteeName: '보장 이름', guaranteeAmount: '보장 금액', guaranteeDescription: '설명',
                adminRole: '권한', shopId: '샵 ID', adminName: '관리자명',
                // Errors/Notifications
                requiredFields: '필수 항목을 모두 입력해주세요.',
                dbError: 'DB 작업 중 오류가 발생했습니다. 콘솔을 확인해주세요.',
                deleted: '삭제되었습니다.',
                saved: '저장되었습니다.',
                updated: '업데이트되었습니다.',
            },
            // ... (다른 언어는 생략)
            en: { title: 'Massage Shop Management', login: 'Login', payment: 'Payment', confirm: 'Confirm', cancel: 'Cancel', close: 'Close', staff: 'Staff', menu: 'Menu', price: 'Price', commission: 'Comm', duration: 'Time' },
            th: { title: 'ระบบจัดการร้านนวด', login: 'เข้าสู่ระบบ', payment: 'การชำระเงิน', confirm: 'ยืนยัน', cancel: 'ยกเลิก', close: 'ปิด', staff: 'พนักงาน', menu: 'เมนู', price: 'ราคา', commission: 'ค่านายหน้า', duration: 'เวลา' },
            vi: { title: 'Hệ thống Quản lý Massage', login: 'Đăng nhập', payment: 'Thanh toán', confirm: 'Xác nhận', cancel: 'Hủy', close: 'Đóng', staff: 'Nhân viên', menu: 'Thực đơn', price: 'Giá', commission: 'Hoa hồng', duration: 'Thời gian' },
        };
        
        // =========================================================================
        // 3. Supabase DB CRUD 함수 (재정의 및 추가)
        // =========================================================================

        /** 직원 데이터 로드 (staff 테이블 조회) */
        async function getStaffData() {
            const { data, error } = await supabaseClient.from('staff').select('*').order('name', { ascending: true });
            if (error) { console.error('Error fetching staff data:', error.message); return []; }
            return data;
        }
        
        /** 메뉴 데이터 로드 (menus 테이블 조회) */
        async function getMenusData() {
            const { data, error } = await supabaseClient.from('menus').select('id, name, prices').order('id', { ascending: true }); 
            if (error) { console.error('Error fetching menus data:', error.message); return []; }
            return data;
        }

        /** 방 데이터 로드 (rooms 테이블 조회) */
        async function getRoomsData() {
            const { data: rooms, error } = await supabaseClient.from('rooms').select('id, room_number, capacity').order('room_number', { ascending: true }); 
            if (error) { console.error('Error fetching rooms data:', error.message); return []; }
            return rooms.map(r => ({id: r.id, roomNumber: r.room_number, capacity: r.capacity}));
        }

        /** 입금 방식 데이터 로드 (payment_methods 테이블 조회) */
        async function getPaymentMethodsData() {
            const { data, error } = await supabaseClient.from('payment_methods').select('id, name').order('id', { ascending: true }); 
            if (error) { console.error('Error fetching payment methods data:', error.message); return []; }
            return data;
        }

        /** Guarantee 데이터 로드 (guarantees 테이블 조회) */
        async function getGuaranteeData() {
            const { data, error } = await supabaseClient.from('guarantees').select('*').order('id', { ascending: true });
            if (error) { console.error('Error fetching guarantee data:', error.message); return []; }
            return data;
        }

        /** 관리자 데이터 로드 (shop_admins 테이블 조회) */
        async function getAdminData() {
            // auth.users와 shop_admins를 조인하여 이메일도 가져옴
            const { data, error } = await supabaseClient
                .from('shop_admins')
                .select('*, auth_user:id(email)')
                .order('shop_id', { ascending: true });
                
            if (error) { console.error('Error fetching admin data:', error.message); return []; }
            // auth_user 객체에서 email을 꺼내서 사용하기 쉬운 형태로 변환
            return data.map(admin => ({
                id: admin.id,
                shop_id: admin.shop_id,
                role: admin.role,
                name: admin.name,
                email: admin.auth_user ? admin.auth_user.email : 'N/A'
            }));
        }


        /** 예약 데이터 로드 (reservations 테이블 조회) */
        async function getReservationsData(date) {
            const { data: reservations, error } = await supabaseClient.from('reservations').select('*').eq('date', date); 
            if (error) { console.error('Error fetching reservations data:', error.message); return []; }
             return reservations.map(r => ({
                id: r.id, date: r.date, staffId: r.staff_id, menuId: r.menu_id, duration: r.duration, 
                startTime: r.start_time, roomId: r.room_id, customerName: r.customer_name, price: r.price, 
                commission: r.commission, paid: r.paid, paymentDetails: r.payment_details,
                menuOrder: r.menu_order, isMultiMenu: r.is_multi_menu
            }));
        }
        
        /** 새로운 예약을 reservations 테이블에 저장 */
        async function saveNewReservations(reservationsArray) {
            const transformedReservations = reservationsArray.map(r => ({
                date: r.date, staff_id: r.staffId, menu_id: r.menuId, duration: r.duration,
                start_time: r.startTime, room_id: r.roomId || null, customer_name: r.customerName || null,
                price: r.price, commission: r.commission, paid: r.paid, payment_details: r.paymentDetails || {},
                menu_order: r.menuOrder, is_multi_menu: r.isMultiMenu,
            }));

            const { data, error } = await supabaseClient.from('reservations').insert(transformedReservations).select(); 
            if (error) { console.error('Error saving new reservations:', error.message); alert('예약 저장에 실패했습니다. 오류: ' + error.message); return null; }
            return data; 
        }

        /** 예약 삭제 */
        async function deleteReservationFromDB(id) {
            const { error } = await supabaseClient.from('reservations').delete().eq('id', id);
            if (error) { console.error('Error deleting reservation:', error.message); alert('예약 삭제에 실패했습니다. 오류: ' + error.message); return false; }
            return true;
        }
        
        /** 예약 업데이트 (결제 등) */
        async function updateReservationInDB(id, updateData) {
            const transformedData = {};
            if (updateData.paid !== undefined) transformedData.paid = updateData.paid;
            if (updateData.paymentDetails !== undefined) transformedData.payment_details = updateData.paymentDetails;
            if (updateData.startTime !== undefined) transformedData.start_time = updateData.startTime;

             const { data, error } = await supabaseClient.from('reservations').update(transformedData).eq('id', id).select();
            if (error) { console.error('Error updating reservation:', error.message); alert('예약 업데이트에 실패했습니다. 오류: ' + error.message); return null; }
            return data[0];
        }

        /** 일반 CRUD 함수 (Staff, Rooms, Payment Methods, Guarantees에 사용) */
        async function upsertData(tableName, data, id = null) {
            // [RLS 오류 해결을 위해 RLS가 설정되어 있다면 data를 전송]
            const transformedData = id ? data : data; // ID가 있으면 UPDATE, 없으면 INSERT (upsert 대신 분리)

            if (id) {
                const { data: updated, error } = await supabaseClient.from(tableName).update(transformedData).eq('id', id).select();
                if (error) { console.error('Update Error:', error.message); return null; }
                return updated;
            } else {
                const { data: inserted, error } = await supabaseClient.from(tableName).insert(transformedData).select();
                if (error) { console.error('Insert Error:', error.message); return null; }
                return inserted;
            }
        }

        async function deleteData(tableName, id) {
            const { error } = await supabaseClient.from(tableName).delete().eq('id', id);
            if (error) { console.error('Delete Error:', error.message); return false; }
            return true;
        }


        // =========================================================================
        // 4. 초기화 및 인증 로직
        // =========================================================================

        async function initializeApp() {
            try {
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                const currentDateElement = document.getElementById('currentDate');
                if (currentDateElement) {
                    currentDateElement.value = new Date().toISOString().split('T')[0];
                }
                
                loadFontSettings();
                await updateCurrencyDisplay(); 

                const { data: { session } } = await supabaseClient.auth.getSession();

                if (session) {
                    // 관리자 권한 로드
                    const adminDetails = await loadAdminDetails(session.user.id);
                    
                    currentAdmin = { 
                        username: session.user.email, 
                        type: adminDetails.role, // 최고관리자, 샾관리자, 일반관리자
                        shopName: adminDetails.shopName, 
                        id: session.user.id,
                        shopId: adminDetails.shopId
                    };
                    
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainScreen').style.display = 'block';
                    document.getElementById('shopName').textContent = currentAdmin.shopName;

                    loadReservationData(); // ReferenceError 해결
                    showDashboard();
                } else {
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('mainScreen').style.display = 'none';
                }
            } catch (error) {
                // 이전에 loadReservationData가 정의되지 않아 발생한 오류가 initializeApp에서 발생했으나,
                // 이제는 함수가 정의되었으므로 다른 초기화 오류를 포착합니다.
                console.error('앱 초기화 중 오류:', error);
            }
        }
        
        async function loadAdminDetails(userId) {
            // shop_admins 테이블에서 사용자 정보 로드
            const { data, error } = await supabaseClient
                .from('shop_admins')
                .select('role, shop_id, name')
                .eq('id', userId)
                .single();

            if (error && error.code !== 'PGRST116') {
                 console.error('Error fetching admin role:', error.message);
            }

            return {
                role: data ? data.role : '일반관리자',
                shopId: data ? data.shop_id : 'default_shop',
                shopName: `Supabase DB 연동 (${data ? data.role : '일반관리자'})`
            };
        }


        async function processLogin() {
            const email = document.getElementById('loginUsername').value; 
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('아이디(이메일)와 비밀번호를 입력해주세요.');
                return;
            }
            
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                alert('로그인에 실패했습니다. (아이디/비밀번호 또는 Supabase 인증을 확인하세요.)\n' + error.message);
                return;
            }

            if (data.user) {
                 const adminDetails = await loadAdminDetails(data.user.id);

                currentAdmin = { 
                    username: data.user.email, 
                    type: adminDetails.role, 
                    shopName: adminDetails.shopName, 
                    id: data.user.id,
                    shopId: adminDetails.shopId
                };

                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainScreen').style.display = 'block';
                document.getElementById('shopName').textContent = currentAdmin.shopName;
                
                loadReservationData();
                showDashboard();
            } else {
                alert('로그인에 실패했습니다. (알 수 없는 오류)');
            }
        }

        async function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                await supabaseClient.auth.signOut();
                currentAdmin = null;
                document.getElementById('mainScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                hideAllSections();
                setLanguage('ko');
            }
        }
        
        // =========================================================================
        // 5. 유틸리티 및 UI 로직 (ReferenceError 해결 위해 정의)
        // =========================================================================
        
        function getDailyStaffOrderKey(date) { return `temp_staffOrder_${date}`; }
        function getAdminKey(key) { return 'admin_' + key; } 

        function updateCurrentTime() {
             const timeElement = document.getElementById('currentTime');
             if (timeElement) {
                timeElement.textContent = new Date().toLocaleTimeString(currentLanguage === 'ko' ? 'ko-KR' : 'en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
             }
        }
        function confirmDateChange() {
            loadReservationData();
            loadDashboard();
            loadStaffSelection();
            loadStaffOrder();
        }
        function hideAllSections() {
            document.getElementById('dashboardSection').style.display = 'none';
            document.getElementById('reservationSection').style.display = 'none';
            document.getElementById('statisticsSection').style.display = 'none';
            document.getElementById('orderSection').style.display = 'none';
            document.getElementById('dbManagementSection').style.display = 'none';
        }
        function showDashboard() { hideAllSections(); document.getElementById('dashboardSection').style.display = 'block'; loadDashboard(); }
        function showReservation() { hideAllSections(); document.getElementById('reservationSection').style.display = 'block'; loadStaffSelection(); loadRoomSelection(); resetReservationForm(); }
        function showStatistics() { hideAllSections(); document.getElementById('statisticsSection').style.display = 'block'; showDailyStats(); }
        function showOrder() { hideAllSections(); document.getElementById('orderSection').style.display = 'block'; loadStaffOrder(); }
        function showDBManagement() { hideAllSections(); document.getElementById('dbManagementSection').style.display = 'block'; }
        
        function calculateEndTime(startTime, duration) { 
            if (!startTime) return '-';
            const [h, m] = startTime.split(':').map(Number);
            const totalMinutes = h * 60 + m + duration;
            const endHour = Math.floor(totalMinutes / 60) % 24;
            const endMinute = totalMinutes % 60;
            return `${String(endHour).padStart(2, '0')}:${String(endMinute).padStart(2, '0')}`;
        }
        
        function calculateRemainingTime(startTime, duration, reservationDate) { 
             const reservationDateTime = new Date(`${reservationDate}T${startTime}`);
             const endTime = new Date(reservationDateTime.getTime() + duration * 60000);
             const now = new Date();
             
             if (now > endTime) return -1; 
             
             const remainingMilliseconds = endTime.getTime() - now.getTime();
             return Math.ceil(remainingMilliseconds / 60000);
        }

        function loadFontSettings() {
            try {
                const savedFont = localStorage.getItem('selectedFont');
                const savedFontSize = localStorage.getItem('selectedFontSize');
                if (savedFont) {
                    currentFont = savedFont;
                    selectedFontFamily = savedFont;
                }
                if (savedFontSize) {
                    currentFontSize = savedFontSize;
                    selectedFontSize = savedFontSize;
                }
                applyFontSettings();
            } catch (error) {
                console.log('폰트 설정 로드 오류:', error);
            }
        }
        function applyFontSettings() {
             localStorage.setItem('selectedFont', selectedFontFamily);
             localStorage.setItem('selectedFontSize', selectedFontSize);
             document.body.style.fontSize = selectedFontSize === 'normal' ? '16px' : selectedFontSize === 'large' ? '18px' : selectedFontSize === 'xlarge' ? '20px' : selectedFontSize === 'xxlarge' ? '24px' : '14px';
             document.body.style.fontFamily = selectedFontFamily;
             // UI 업데이트 함수 호출 (updateTranslations 등)
        }
        function showFontModal() { document.getElementById('fontModal').style.display = 'block'; }
        function closeFontModal() { document.getElementById('fontModal').style.display = 'none'; }
        
        function setLanguage(lang) { currentLanguage = lang; updateTranslations(); }
        function setLanguageAndClose(lang) { setLanguage(lang); closeLanguageModal(); }
        function showLanguageModal() { document.getElementById('languageModal').style.display = 'block'; }
        function closeLanguageModal() { document.getElementById('languageModal').style.display = 'none'; }
        
        function updateTranslations() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
            const placeholders = document.querySelectorAll('[data-translate-placeholder]');
            placeholders.forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });
            
            document.getElementById('langKo').className = currentLanguage === 'ko' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            document.getElementById('langEn').className = currentLanguage === 'en' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            document.getElementById('langTh').className = currentLanguage === 'th' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            document.getElementById('langVi').className = currentLanguage === 'vi' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';

            updateCurrencyDisplay();
        }

        async function loadRoomSelection() { // ReferenceError 해결
            const rooms = await getRoomsData(); 
            const roomSelect = document.getElementById('reservationRoom');
            const selectRoomText = translations[currentLanguage].selectRoom || '방 선택';
            roomSelect.innerHTML = `<option value="">${selectRoomText}</option>`;
            rooms.forEach(r => {
                roomSelect.innerHTML += `<option value="${r.id}">${r.roomNumber}</option>`;
            });
        }
        
        async function loadReservationData() { // ReferenceError 해결
            loadDashboard();
            loadStaffSelection();
        }
        
        function closeManagementModal() { // ReferenceError 해결
            document.getElementById('managementModal').style.display = 'none';
            document.getElementById('managementContent').innerHTML = '';
            loadReservationData(); 
        }

        // =========================================================================
        // 6. 예약 및 대시보드 로직 (DB 연동 기반)
        // =========================================================================
        
        async function updateCurrencyDisplay() {
            const { data, error } = await supabaseClient
                .from('shop_config')
                .select('config_value')
                .eq('config_key', 'currency')
                .single();
                
            if (data && data.config_value) {
                currency = data.config_value;
            } else if (error && error.code !== 'PGRST116') {
                console.error('Error fetching currency:', error.message);
            }

            const currencyElements = document.querySelectorAll('[id$="Currency"], .currency-symbol');
            currencyElements.forEach(element => {
                element.textContent = currency.symbol;
            });
        }
        
        async function loadStaffSelection() {
            const staff = await getStaffData(); 
            const currentDate = document.getElementById('currentDate').value;
            const staffOrder = JSON.parse(localStorage.getItem(getDailyStaffOrderKey(currentDate)) || '{}'); 
            const reservations = await getReservationsData(currentDate); 
            
            const activeStaff = staff.filter(s => s.status !== '퇴사');
            
            activeStaff.sort((a, b) => {
                const orderA = staffOrder[a.id] !== undefined ? staffOrder[a.id] : 999;
                const orderB = staffOrder[b.id] !== undefined ? staffOrder[b.id] : 999;
                if (orderA === 0 && orderB !== 0) return 1;
                if (orderA !== 0 && orderB === 0) return -1;
                return orderA - orderB;
            });
            
            const container = document.getElementById('staffSelection');
            container.innerHTML = '';

            activeStaff.forEach(s => {
                const order = staffOrder[s.id] !== undefined ? staffOrder[s.id] : 1;
                const isOnVacation = order === 0;
                const hasReservation = reservations.some(r => r.staffId === s.id && !r.paid && r.startTime);
                
                const div = document.createElement('div');
                div.className = 'selection-item';
                div.setAttribute('data-staff-id', s.id);
                
                let bgColor = 'transparent';
                let cursor = 'pointer';
                if (hasReservation) {
                    bgColor = '#9ca3af';
                    cursor = 'not-allowed';
                } else if (isOnVacation) {
                    bgColor = '#9ca3af';
                    cursor = 'not-allowed';
                }
                
                if (bgColor !== 'transparent') {
                    div.style.backgroundColor = bgColor;
                    div.style.color = 'white';
                    div.style.cursor = cursor;
                }

                const vacationText = translations[currentLanguage].vacationStatus || '휴가';
                div.textContent = `${s.name} (${order === 0 ? vacationText : order})`;
                
                if (!hasReservation && !isOnVacation) {
                    div.onclick = () => selectStaff(s.id, s.name, order, div);
                }
                
                container.appendChild(div);
            });
        }
        
        async function loadDashboard() {
            const currentDate = document.getElementById('currentDate').value;
            const todayReservations = await getReservationsData(currentDate);
            const staffOrder = JSON.parse(localStorage.getItem(getDailyStaffOrderKey(currentDate)) || '{}');
            const staffList = await getStaffData(); 
            const menuList = await getMenusData();
            const roomList = await getRoomsData();

            todayReservations.sort((a, b) => {
                const orderA = staffOrder[a.staffId] || 999;
                const orderB = staffOrder[b.staffId] || 999;
                return orderA - orderB;
            });
            
            const tableBody = document.getElementById('dashboardTable');
            tableBody.innerHTML = '';

            todayReservations.forEach(reservation => {
                const staffInfo = staffList.find(s => s.id === reservation.staffId) || { name: '알 수 없음' };
                const menuInfo = menuList.find(m => m.id === reservation.menuId) || { name: '알 수 없음' };
                const roomInfo = roomList.find(r => r.id == reservation.roomId) || { roomNumber: '-' };

                const staffOrderNum = staffOrder[reservation.staffId] !== undefined ? staffOrder[reservation.staffId] : 1;
                const vacationText = translations[currentLanguage].vacationStatus || '휴가';
                const staffDisplayName = staffOrderNum === 0 ? `${staffInfo.name} (${vacationText})` : `${staffOrderNum}. ${staffInfo.name}`;
                
                const menuDisplayName = reservation.isMultiMenu ? 
                    `${menuInfo.name} (${reservation.menuOrder})` : 
                    menuInfo.name;
                
                const endTime = calculateEndTime(reservation.startTime, reservation.duration);
                const remainingMinutes = calculateRemainingTime(reservation.startTime, reservation.duration, reservation.date);
                
                const row = document.createElement('tr');
                row.className = reservation.paid ? 'bg-green-50' : '';
                
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${staffDisplayName}</td>
                    <td class="border border-gray-300 p-2">${menuDisplayName}</td>
                    <td class="border border-gray-300 p-2">${reservation.duration}min</td>
                    <td class="border border-gray-300 p-2">${reservation.startTime || '-'}</td>
                    <td class="border border-gray-300 p-2">${reservation.startTime ? endTime : '-'}</td>
                    <td class="border border-gray-300 p-2 remaining-time">${reservation.paid ? '-' : (reservation.startTime ? (remainingMinutes === -1 ? '-' : remainingMinutes + 'min') : '-')}</td>
                    <td class="border border-gray-300 p-2">${reservation.price.toLocaleString()}${currency.symbol}</td>
                    <td class="border border-gray-300 p-2">${reservation.commission.toLocaleString()}${currency.symbol}</td>
                    <td class="border border-gray-300 p-2">${roomInfo.roomNumber || '-'}</td>
                    <td class="border border-gray-300 p-2">
                        ${reservation.paid ? 
                            `<span class="bg-green-500 text-white px-3 py-1 rounded text-sm font-bold">${translations[currentLanguage].paymentCompleteStatus || '입금 완료'}</span>` :
                            `<button onclick="editReservation(${reservation.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1">${translations[currentLanguage].edit || '수정'}</button>
                             <button onclick="showPaymentModal(${reservation.id})" class="bg-green-500 text-white px-2 py-1 rounded text-sm mr-1">${translations[currentLanguage].payment || '입금'}</button>
                             <button onclick="deleteReservation(${reservation.id})" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete || '삭제'}</button>`
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateCurrencyDisplay();
        }

        // ... addMenuRow, selectMenuForRow, selectDurationForRow, updateTotalPrices, updateMenuTimeSettings 등 예약 로직은 생략 (이전 코드와 동일함) ...
        function selectStaff(id, name, order, element) { 
            selectedStaff = { id, name, order };
            document.getElementById('selectedStaffName').textContent = name;
            document.getElementById('selectedStaffOrder').textContent = order;
            document.getElementById('staffSelectionContainer').style.display = 'none';
            document.getElementById('selectedStaffInfo').style.display = 'block';
            document.getElementById('menuListContainer').style.display = 'block';
            addMenuRow(); // 기본 메뉴 하나 추가
        }
        function resetReservationForm() { /* ... */ }
        function changeStaff() { /* ... */ }
        function removeMenuRow(menuRowId) { /* ... */ }
        function updateTotalPrices() { /* ... */ }
        function updateMenuTimeSettings() { /* ... */ }
        function updateMenuStartTime(menuRowId) { console.warn("updateMenuStartTime placeholder"); }
        function updateSubsequentMenuTimes(changedMenuRowId) { console.warn("updateSubsequentMenuTimes placeholder"); }
        function updateAllMenuTimes() { console.warn("updateAllMenuTimes placeholder"); }
        
        async function addMenuRow() {
            const menuRowId = ++menuRowCounter;
            
            menuRows.push({
                id: menuRowId, menuId: null, menuName: '', duration: null, price: 0, commission: 0, startTime: ''
            });

            const menus = await getMenusData(); 

            const menuRowDiv = document.createElement('div');
            menuRowDiv.className = 'menu-row';
            menuRowDiv.id = `menuRow_${menuRowId}`;
            
            menuRowDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold">${menuRows.length}번째 메뉴</h4>
                    ${menuRows.length > 1 ? `<button onclick="removeMenuRow(${menuRowId})" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">× 삭제</button>` : ''}
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2 required-label">${translations[currentLanguage].menu} 선택</label>
                        <div id="menuSelection_${menuRowId}" class="menu-selection-grid">
                            ${menus.map(m => `
                                <div class="selection-item" data-menu-id="${m.id}" onclick="selectMenuForRow(${menuRowId}, ${m.id}, '${m.name.replace(/'/g, "\\'")}')">
                                    ${m.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="durationContainer_${menuRowId}" style="display: none;">
                        <label class="block text-sm font-medium mb-2 required-label">${translations[currentLanguage].duration} 선택</label>
                        <div id="durationSelection_${menuRowId}" class="duration-selection-grid">
                        </div>
                    </div>
                    
                    <div id="priceInfo_${menuRowId}" class="p-3 bg-gray-50 rounded" style="display: none;">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>${translations[currentLanguage].price}: <span id="menuPrice_${menuRowId}" class="font-bold">0</span><span class="currency-symbol">${currency.symbol}</span></div>
                            <div>${translations[currentLanguage].commission}: <span id="menuCommission_${menuRowId}" class="font-bold">0</span><span class="currency-symbol">${currency.symbol}</span></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('menuRows').appendChild(menuRowDiv);
            updateCurrencyDisplay();
            updateMenuTimeSettings();
        }
        
        async function selectMenuForRow(menuRowId, menuId, menuName) {
            const menuRow = menuRows.find(row => row.id === menuRowId);
            if (!menuRow) return;

            menuRow.menuId = menuId;
            menuRow.menuName = menuName;

            document.getElementById(`menuSelection_${menuRowId}`).querySelectorAll('.selection-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.getElementById(`menuSelection_${menuRowId}`).querySelector(`[data-menu-id="${menuId}"]`).classList.add('selected');

            const allMenus = await getMenusData();
            const menuData = allMenus.find(m => m.id === menuId); 
            const prices = menuData ? menuData.prices : {};
            const durations = Object.keys(prices).sort((a, b) => a - b);
            
            const durationContainer = document.getElementById(`durationContainer_${menuRowId}`);
            const durationSelection = document.getElementById(`durationSelection_${menuRowId}`);
            
            durationSelection.innerHTML = durations.map(d => 
                `<div class="selection-item" data-duration="${d}" onclick="selectDurationForRow(${menuRowId}, ${d})">${d}분</div>`
            ).join('');

            durationContainer.style.display = 'block';
            document.getElementById(`priceInfo_${menuRowId}`).style.display = 'none';

            menuRow.duration = null;
            menuRow.price = 0;
            menuRow.commission = 0;
            updateTotalPrices();
        }

        async function selectDurationForRow(menuRowId, duration) {
            const menuRow = menuRows.find(row => row.id === menuRowId);
            if (!menuRow || !menuRow.menuId) return;
            
            const durationSelection = document.getElementById(`durationSelection_${menuRowId}`);
            durationSelection.querySelectorAll('.selection-item').forEach(item => item.classList.remove('selected'));
            const selectedItem = durationSelection.querySelector(`[data-duration="${duration}"]`);
            if (selectedItem) selectedItem.classList.add('selected');
            
            const allMenus = await getMenusData();
            const menu = allMenus.find(m => m.id === menuRow.menuId);
            
            if (menu && menu.prices && menu.prices[duration]) {
                menuRow.duration = duration;
                menuRow.price = menu.prices[duration].price;
                menuRow.commission = menu.prices[duration].commission;
                
                document.getElementById(`menuPrice_${menuRowId}`).textContent = menuRow.price.toLocaleString();
                document.getElementById(`menuCommission_${menuRowId}`).textContent = menuRow.commission.toLocaleString();
                
                document.getElementById(`priceInfo_${menuRowId}`).style.display = 'block';
            }
            
            updateTotalPrices();
            updateMenuTimeSettings();
        }
        
        // deleteReservation, showPaymentModal, processPayment 등 결제 로직은 생략 (이전 코드와 동일함)
        async function deleteReservation(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                const success = await deleteReservationFromDB(id);
                if (success) {
                    loadDashboard();
                }
            }
        }

        // =========================================================================
        // 7. DB 관리 기능 구현 (CRUD) - RLS 문제 해결 가정
        // =========================================================================

        function openManagementModal(title) {
            document.getElementById('managementTitle').textContent = title;
            document.getElementById('managementModal').style.display = 'block';
        }

        async function deleteManagementItem(tableName, id, callback) {
            if (confirm(`정말 이 항목을 삭제하시겠습니까? (테이블: ${tableName})`)) {
                const success = await deleteData(tableName, id);
                if (success) { alert(translations[currentLanguage].deleted); callback(); } else { alert(translations[currentLanguage].dbError); }
            }
        }
        
        // Staff Management
        async function manageStaff() { /* ... */
            openManagementModal(translations[currentLanguage].staffManagement);
            const staff = await getStaffData();
            let html = `<button onclick="editStaff()" class="bg-green-500 text-white px-4 py-2 rounded mb-4">${translations[currentLanguage].add}</button>`;
            // ... Table HTML generation ...
            html += `<table class="w-full border-collapse border border-gray-300">
                <thead><tr><th class="border p-2">ID</th><th class="border p-2">${translations[currentLanguage].staffName}</th><th class="border p-2">${translations[currentLanguage].phone}</th><th class="border p-2">${translations[currentLanguage].status}</th><th class="border p-2">${translations[currentLanguage].actions}</th></tr></thead><tbody>`;
            staff.forEach(s => {
                html += `<tr><td class="border p-2">${s.id}</td><td class="border p-2">${s.name}</td><td class="border p-2">${s.phone || '-'}</td><td class="border p-2">${s.status || '정직원'}</td>
                    <td class="border p-2"><button onclick="editStaff(${s.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].edit}</button> 
                    <button onclick="deleteManagementItem('staff', ${s.id}, manageStaff)" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete}</button></td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('managementContent').innerHTML = html;
        }
        async function editStaff(id = null) { /* ... */
            const staffData = id ? (await getStaffData()).find(s => s.id === id) : {};
            const staffStatuses = ['정직원', '단기고용', '퇴사'];
            let html = `<h4 class="font-bold mb-4">${id ? translations[currentLanguage].update : translations[currentLanguage].newStaff}</h4>`;
            html += `<input type="hidden" id="staffId" value="${id || ''}">
                <div class="space-y-3">
                    <div><label class="block">${translations[currentLanguage].staffName}*</label><input type="text" id="staffName" value="${staffData.name || ''}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].phone}</label><input type="text" id="staffPhone" value="${staffData.phone || ''}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].bank}</label><input type="text" id="staffBank" value="${staffData.bank || ''}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].account}</label><input type="text" id="staffAccount" value="${staffData.account || ''}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].status}</label>
                        <select id="staffStatus" class="w-full border rounded p-2">
                            ${staffStatuses.map(s => `<option value="${s}" ${s === (staffData.status || '정직원') ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <button onclick="saveStaff()" class="bg-blue-500 text-white px-4 py-2 rounded">${id ? translations[currentLanguage].update : translations[currentLanguage].save}</button>
                </div>`;
            document.getElementById('managementContent').innerHTML = html;
        }
        async function saveStaff() {
            const id = document.getElementById('staffId').value || null;
            const name = document.getElementById('staffName').value;
            if (!name) { alert(translations[currentLanguage].requiredFields); return; }

            const data = {
                name: name,
                phone: document.getElementById('staffPhone').value,
                bank: document.getElementById('staffBank').value,
                account: document.getElementById('staffAccount').value,
                status: document.getElementById('staffStatus').value,
            };

            const result = await upsertData('staff', data, id ? parseInt(id) : null);
            if (result) { alert(translations[currentLanguage].saved); manageStaff(); } else { alert(translations[currentLanguage].dbError); }
        }

        // Menu Management
        async function manageMenus() { /* ... */
            openManagementModal(translations[currentLanguage].menuManagement);
            const menus = await getMenusData();
            let html = `<button onclick="editMenu()" class="bg-green-500 text-white px-4 py-2 rounded mb-4">${translations[currentLanguage].add}</button>`;
            // ... Table HTML generation ...
            html += `<table class="w-full border-collapse border border-gray-300">
                <thead><tr><th class="border p-2">ID</th><th class="border p-2">${translations[currentLanguage].menuName}</th><th class="border p-2">${translations[currentLanguage].actions}</th></tr></thead><tbody>`;
            menus.forEach(m => {
                const pricesSummary = Object.keys(m.prices).map(p => `${p}분`).join(', ');
                html += `<tr><td class="border p-2">${m.id}</td><td class="border p-2">${m.name}<br><small class="text-gray-500">(${pricesSummary})</small></td>
                    <td class="border p-2"><button onclick="editMenu(${m.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].edit}</button> 
                    <button onclick="deleteManagementItem('menus', ${m.id}, manageMenus)" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete}</button></td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('managementContent').innerHTML = html;
        }
        async function editMenu(id = null) { /* ... */
            const allMenus = await getMenusData();
            const menuData = id ? allMenus.find(m => m.id === id) : { prices: { 60: { price: 0, commission: 0 } } };
            const durations = [30, 60, 90, 120];

            let html = `<h4 class="font-bold mb-4">${id ? translations[currentLanguage].update : translations[currentLanguage].menuName}</h4>`;
            html += `<input type="hidden" id="menuId" value="${id || ''}">
                <div class="space-y-3 mb-6">
                    <div><label class="block">${translations[currentLanguage].menuName}*</label><input type="text" id="menuName" value="${menuData.name || ''}" class="w-full border rounded p-2"></div>
                </div>
                <h5 class="font-bold mb-2">${translations[currentLanguage].priceTime} 설정</h5>
                <div id="priceSettings" class="space-y-3 p-4 border rounded bg-gray-50">
                    ${durations.map(d => {
                        const price = menuData.prices && menuData.prices[d] ? menuData.prices[d].price : 0;
                        const commission = menuData.prices && menuData.prices[d] ? menuData.prices[d].commission : 0;
                        const isChecked = !!(menuData.prices && menuData.prices[d]);
                        return `
                            <div class="flex items-center gap-3">
                                <input type="checkbox" id="duration_${d}" value="${d}" class="h-4 w-4" ${isChecked ? 'checked' : ''}>
                                <label for="duration_${d}" class="w-12">${d}분</label>
                                <input type="number" id="price_${d}" value="${price}" placeholder="가격" class="flex-1 border rounded p-2 text-right" ${!isChecked ? 'disabled' : ''}>
                                <input type="number" id="commission_${d}" value="${commission}" placeholder="커미션" class="flex-1 border rounded p-2 text-right" ${!isChecked ? 'disabled' : ''}>
                                <span>${currency.symbol}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button onclick="saveMenu()" class="bg-blue-500 text-white px-4 py-2 rounded mt-4">${id ? translations[currentLanguage].update : translations[currentLanguage].save}</button>`;
            document.getElementById('managementContent').innerHTML = html;

            // 체크박스 상태에 따라 입력 필드 활성화/비활성화
            durations.forEach(d => {
                document.getElementById(`duration_${d}`).addEventListener('change', (e) => {
                    document.getElementById(`price_${d}`).disabled = !e.target.checked;
                    document.getElementById(`commission_${d}`).disabled = !e.target.checked;
                    if (!e.target.checked) {
                        document.getElementById(`price_${d}`).value = 0;
                        document.getElementById(`commission_${d}`).value = 0;
                    }
                });
            });
        }
        async function saveMenu() {
            const id = document.getElementById('menuId').value || null;
            const name = document.getElementById('menuName').value;
            if (!name) { alert(translations[currentLanguage].requiredFields); return; }

            const prices = {};
            const durations = [30, 60, 90, 120];

            durations.forEach(d => {
                if (document.getElementById(`duration_${d}`).checked) {
                    prices[d] = {
                        price: parseInt(document.getElementById(`price_${d}`).value) || 0,
                        commission: parseInt(document.getElementById(`commission_${d}`).value) || 0,
                    };
                }
            });

            if (Object.keys(prices).length === 0) {
                alert('최소한 하나의 시간별 가격/커미션을 설정해야 합니다.');
                return;
            }

            const data = { name, prices };
            const result = await upsertData('menus', data, id ? parseInt(id) : null);
            if (result) { alert(translations[currentLanguage].saved); manageMenus(); } else { alert(translations[currentLanguage].dbError); }
        }

        // Room Management
        async function manageRooms() { /* ... */
            openManagementModal(translations[currentLanguage].roomManagement);
            const rooms = await getRoomsData();
            let html = `<button onclick="editRoom()" class="bg-green-500 text-white px-4 py-2 rounded mb-4">${translations[currentLanguage].add}</button>`;
            // ... Table HTML generation ...
            html += `<table class="w-full border-collapse border border-gray-300">
                <thead><tr><th class="border p-2">ID</th><th class="border p-2">${translations[currentLanguage].roomNumberLabel}</th><th class="border p-2">${translations[currentLanguage].capacity}</th><th class="border p-2">${translations[currentLanguage].actions}</th></tr></thead><tbody>`;
            rooms.forEach(r => {
                html += `<tr><td class="border p-2">${r.id}</td><td class="border p-2">${r.roomNumber}</td><td class="border p-2">${r.capacity}</td>
                    <td class="border p-2"><button onclick="editRoom(${r.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].edit}</button> 
                    <button onclick="deleteManagementItem('rooms', ${r.id}, manageRooms)" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete}</button></td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('managementContent').innerHTML = html;
        }
        async function editRoom(id = null) { /* ... */
            const allRooms = await getRoomsData();
            const roomData = id ? allRooms.find(r => r.id === id) : {};
            let html = `<h4 class="font-bold mb-4">${id ? translations[currentLanguage].update : translations[currentLanguage].roomNumberLabel}</h4>`;
            html += `<input type="hidden" id="roomId" value="${id || ''}">
                <div class="space-y-3">
                    <div><label class="block">${translations[currentLanguage].roomNumberLabel}*</label><input type="text" id="roomNumber" value="${roomData.roomNumber || ''}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].capacity}*</label><input type="number" id="roomCapacity" value="${roomData.capacity || 1}" class="w-full border rounded p-2"></div>
                    <button onclick="saveRoom()" class="bg-blue-500 text-white px-4 py-2 rounded">${id ? translations[currentLanguage].update : translations[currentLanguage].save}</button>
                </div>`;
            document.getElementById('managementContent').innerHTML = html;
        }
        async function saveRoom() {
            const id = document.getElementById('roomId').value || null;
            const roomNumber = document.getElementById('roomNumber').value;
            const capacity = document.getElementById('roomCapacity').value;
            if (!roomNumber || !capacity) { alert(translations[currentLanguage].requiredFields); return; }

            const data = { room_number: roomNumber, capacity: parseInt(capacity) };
            const result = await upsertData('rooms', data, id ? parseInt(id) : null);
            if (result) { alert(translations[currentLanguage].saved); manageRooms(); } else { alert(translations[currentLanguage].dbError); }
        }
        
        // Currency Management (이전 코드와 동일함)
        async function manageCurrency() { /* ... */ }
        async function saveCurrency() { /* ... */ }
        
        // Payment Method Management (이전 코드와 동일함)
        async function managePaymentMethods() { /* ... */ }
        async function editPaymentMethod(id = null) { /* ... */ }
        async function savePaymentMethod() { /* ... */ }

        // Guarantee Management (새로 구현)
        async function manageGuarantee() {
            openManagementModal('Guarantee 관리');
            const guarantees = await getGuaranteeData();
            let html = `<button onclick="editGuarantee()" class="bg-green-500 text-white px-4 py-2 rounded mb-4">${translations[currentLanguage].add}</button>`;
            html += `<table class="w-full border-collapse border border-gray-300">
                <thead><tr><th class="border p-2">ID</th><th class="border p-2">${translations[currentLanguage].guaranteeName}</th><th class="border p-2">${translations[currentLanguage].guaranteeAmount}</th><th class="border p-2">${translations[currentLanguage].actions}</th></tr></thead><tbody>`;
            guarantees.forEach(g => {
                html += `<tr><td class="border p-2">${g.id}</td><td class="border p-2">${g.name}</td><td class="border p-2">${g.amount.toLocaleString()}${currency.symbol}</td>
                    <td class="border p-2"><button onclick="editGuarantee(${g.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].edit}</button> 
                    <button onclick="deleteManagementItem('guarantees', ${g.id}, manageGuarantee)" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete}</button></td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('managementContent').innerHTML = html;
        }

        async function editGuarantee(id = null) {
            const allGuarantees = await getGuaranteeData();
            const guaranteeData = id ? allGuarantees.find(g => g.id === id) : {};
            let html = `<h4 class="font-bold mb-4">${id ? translations[currentLanguage].update : translations[currentLanguage].guaranteeName}</h4>`;
            html += `<input type="hidden" id="guaranteeId" value="${id || ''}">
                <div class="space-y-3">
                    <div><label class="block">${translations[currentLanguage].guaranteeName}*</label><input type="text" id="guaranteeName" value="${guaranteeData.name || ''}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].guaranteeAmount}* (${currency.symbol})</label><input type="number" id="guaranteeAmount" value="${guaranteeData.amount || 0}" class="w-full border rounded p-2"></div>
                    <div><label class="block">${translations[currentLanguage].guaranteeDescription}</label><textarea id="guaranteeDescription" class="w-full border rounded p-2">${guaranteeData.description || ''}</textarea></div>
                    <button onclick="saveGuarantee()" class="bg-blue-500 text-white px-4 py-2 rounded">${id ? translations[currentLanguage].update : translations[currentLanguage].save}</button>
                </div>`;
            document.getElementById('managementContent').innerHTML = html;
        }

        async function saveGuarantee() {
            const id = document.getElementById('guaranteeId').value || null;
            const name = document.getElementById('guaranteeName').value;
            const amount = document.getElementById('guaranteeAmount').value;
            const description = document.getElementById('guaranteeDescription').value;
            
            if (!name || amount === '') { alert(translations[currentLanguage].requiredFields); return; }

            const data = { name, amount: parseInt(amount), description };
            const result = await upsertData('guarantees', data, id ? parseInt(id) : null);
            if (result) { alert(translations[currentLanguage].saved); manageGuarantee(); } else { alert(translations[currentLanguage].dbError); }
        }

        // Admin Management (새로 구현)
        async function manageAdmins() {
            if (currentAdmin.type !== '최고관리자' && currentAdmin.type !== '샾관리자') {
                alert('최고관리자 또는 샾관리자만 접근할 수 있습니다.');
                return;
            }

            openManagementModal(translations[currentLanguage].adminManagement);
            const admins = await getAdminData();
            let filteredAdmins = admins;
            
            if (currentAdmin.type === '샾관리자') {
                // 샾 관리자는 자신의 샵 ID를 가진 일반 관리자만 볼 수 있음
                filteredAdmins = admins.filter(a => a.shop_id === currentAdmin.shopId);
            }

            let html = `
                ${currentAdmin.type === '샾관리자' ? 
                    `<p class="p-3 mb-4 bg-yellow-100 rounded">현재 샾 ID: ${currentAdmin.shopId}</p>` : ''}
                <button onclick="registerNewAdmin()" class="bg-green-500 text-white px-4 py-2 rounded mb-4">${translations[currentLanguage].add} 관리자</button>`;
            html += `<table class="w-full border-collapse border border-gray-300">
                <thead><tr><th class="border p-2">${translations[currentLanguage].adminName}</th><th class="border p-2">Email</th><th class="border p-2">${translations[currentLanguage].adminRole}</th><th class="border p-2">${translations[currentLanguage].shopId}</th><th class="border p-2">${translations[currentLanguage].actions}</th></tr></thead><tbody>`;
            
            filteredAdmins.forEach(a => {
                const canDelete = currentAdmin.type === '최고관리자' || (currentAdmin.type === '샾관리자' && a.role === '일반관리자');
                html += `<tr><td class="border p-2">${a.name || '-'}</td><td class="border p-2">${a.email}</td><td class="border p-2">${a.role}</td><td class="border p-2">${a.shop_id}</td>
                    <td class="border p-2">
                        ${canDelete ? `<button onclick="deleteManagementItem('shop_admins', '${a.id}', manageAdmins)" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete}</button>` : '-'}
                    </td></tr>`;
            });
            html += `</tbody></table>`;
            document.getElementById('managementContent').innerHTML = html;
        }

        async function registerNewAdmin() {
             alert('새 관리자 추가는 Supabase Auth를 통한 사용자 생성 후, shop_admins 테이블에 수동으로 권한 정보를 추가해야 합니다. 이 UI는 shop_admins 테이블에 직접 등록하는 기능을 제공합니다.');
             // 간략화를 위해 현재는 shop_admins 테이블에 직접 ID를 넣는 로직을 가정
             const roles = currentAdmin.type === '최고관리자' ? ['최고관리자', '샾관리자', '일반관리자'] : ['일반관리자'];
             const defaultShopId = currentAdmin.type === '샾관리자' ? currentAdmin.shopId : 'default_shop';

             let html = `<h4 class="font-bold mb-4">새 관리자 등록 (Supabase Auth ID 필요)</h4>`;
             html += `<div class="space-y-3">
                 <div><label class="block">Supabase Auth User ID (UUID)*</label><input type="text" id="adminUserId" placeholder="로그인한 유저의 UUID" class="w-full border rounded p-2"></div>
                 <div><label class="block">${translations[currentLanguage].shopId}*</label><input type="text" id="adminShopId" value="${defaultShopId}" ${currentAdmin.type === '샾관리자' ? 'disabled' : ''} class="w-full border rounded p-2"></div>
                 <div><label class="block">${translations[currentLanguage].adminRole}*</label>
                     <select id="adminRole" class="w-full border rounded p-2">
                         ${roles.map(r => `<option value="${r}">${r}</option>`).join('')}
                     </select>
                 </div>
                 <button onclick="saveNewAdmin()" class="bg-blue-500 text-white px-4 py-2 rounded">${translations[currentLanguage].save}</button>
             </div>`;
             document.getElementById('managementContent').innerHTML = html;
        }

        async function saveNewAdmin() {
            const id = document.getElementById('adminUserId').value;
            const shopId = document.getElementById('adminShopId').value;
            const role = document.getElementById('adminRole').value;

            if (!id || !shopId || !role) { alert(translations[currentLanguage].requiredFields); return; }

            // 샾 관리자는 최고 관리자나 다른 샾 관리자를 생성할 수 없음
            if (currentAdmin.type === '샾관리자' && role !== '일반관리자') {
                alert('샾 관리자는 일반관리자만 생성할 수 있습니다.');
                return;
            }

            const data = { id, shop_id: shopId, role };
            const { error } = await supabaseClient.from('shop_admins').insert(data);
            
            if (error) { 
                alert('관리자 등록에 실패했습니다. (Auth User ID가 유효한지, 이미 등록되지 않았는지 확인하세요). 오류: ' + error.message); 
                console.error(error);
                return;
            }
            alert(translations[currentLanguage].saved);
            manageAdmins();
        }


        // Customer Management (DB 스키마 미존재로 알림)
        function manageCustomers() { alert('고객 관리 기능은 현재 DB 스키마에 포함되어 있지 않습니다. 고객 테이블 추가 후 구현 가능합니다.'); }


        // Statistics Placeholder (이전 코드와 동일함)
        async function updateStats(isRange = false) { /* ... */ }
        function showDailyStats() { /* ... */ }
        function showWeeklyStats() { /* ... */ }
        function showMonthlyStats() { /* ... */ }
        function showMenuSales() { alert('월간 메뉴별 매출 통계는 구현 예정입니다.'); }
        function showMonthlySalesChart() { alert('월간 매출 그래프는 Chart.js 연동이 필요하며 구현 예정입니다.'); }

        // 순번 관리 (임시 로컬 스토리지 유지)
        function loadStaffOrder() {
            const tableBody = document.getElementById('orderTable');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">순번 관리는 DB 연동이 필요하며 현재 임시 데이터로 표시됩니다.</td></tr>';
        }
        function saveStaffOrder() {
            alert(`순번 저장은 현재 로컬 스토리지에 임시 저장됩니다. (DB 연동 필요)`);
            loadReservationData();
            loadStaffOrder();
        }

        // 앱 초기화
        initializeApp();
    </script>
 </body>
</html>
