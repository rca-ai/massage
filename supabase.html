<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>마사지샵 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 명시적 안정 버전 사용 권장: 필요 시 버전 변경 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/supabase.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 16px; }
    .col { display:block; margin-bottom: 16px; }
    .muted { color: #6b7280; }
    .badge { background:#111827;color:#fff;padding:6px 8px;border-radius:6px;border:none;cursor:pointer;}
    .employee-item { display:flex; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed #e5e7eb; }
    .thumb { width:48px;height:48px;border-radius:6px;object-fit:cover; }
    pre { background:#111827;color:#fff;padding:12px;border-radius:6px; overflow:auto; }
  </style>
  <script>
    // =========================================================================
    // 1. 설정: Supabase 및 상수
    // =========================================================================
    const SUPABASE_URL = "https://lmjtjonlvpqcwdzisijd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtanRqb25sdnBxY3dkemlzaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjY1NDksImV4cCI6MjA3ODcwMjU0OX0.HmfZaxAnaVEEHfLxnlUHxR-PAjrUnFMVWs839xJmKfw";
    const THUMBNAIL_EDGE_FUNCTION_URL = "https://lmjtjonlvpqcwdzisijd.functions.supabase.co/employee-thumbnail-generator";
    const STORAGE_BUCKET = "employee-photos-thumbs";

    // 관리자용: 실행 권장 SQL (복사해서 SQL Editor에서 실행)
    const REQUIRED_SQL = `
-- 확장
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- employees
CREATE TABLE IF NOT EXISTS employees (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  full_name text NOT NULL,
  photo_url text,
  thumbnail_url text,
  is_active boolean DEFAULT true
);

-- services
CREATE TABLE IF NOT EXISTS services (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  duration_minutes int NOT NULL,
  price numeric(10,2) NOT NULL,
  commission numeric(10,2) NOT NULL
);

-- day_orders
CREATE TABLE IF NOT EXISTS day_orders (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  day date NOT NULL,
  employee_id uuid REFERENCES employees(id),
  position int NOT NULL
);

-- bookings
CREATE TABLE IF NOT EXISTS bookings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  day date NOT NULL,
  employee_id uuid REFERENCES employees(id),
  start_at timestamptz NOT NULL,
  end_at timestamptz NOT NULL,
  items jsonb NOT NULL,
  total_price numeric(10,2) NOT NULL,
  total_commission numeric(10,2) NOT NULL,
  created_by uuid
);

-- employee_photos (optional)
CREATE TABLE IF NOT EXISTS employee_photos (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id uuid REFERENCES employees(id),
  original_url text,
  thumbnail_url text,
  uploaded_at timestamptz DEFAULT now()
);
`.trim();

    // =========================================================================
    // 2. DOMContentLoaded 안에서 초기화 (DOM 안전)
    // =========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Supabase 클라이언트 초기화
      const supabase = supabaseJs.createClient ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // DOM refs
      const authArea = document.getElementById('auth-area');
      const employeesList = document.getElementById('employees-list');
      const dashboardArea = document.getElementById('dashboard-area');
      const bookingRoot = document.getElementById('booking-root');
      const statsArea = document.getElementById('stats-area');
      const adminArea = document.getElementById('admin-area');
      const initResult = document.getElementById('init-result');
      const selectedDateInput = document.getElementById('selected-date');
      const btnShowSql = document.getElementById('btn-show-sql');
      const btnCreateSample = document.getElementById('btn-create-sample');

      // 기본 날짜 설정
      if (selectedDateInput) selectedDateInput.value = new Date().toISOString().slice(0,10);

      // ----------------------
      // Auth 렌더링 및 처리
      // ----------------------
      async function renderAuth() {
        try {
          const { data } = await supabase.auth.getUser();
          const user = data?.user ?? null;
          authArea.innerHTML = '';
          if (!user) {
            const form = document.createElement('div');
            form.innerHTML = `
              <input id="email" placeholder="이메일" class="p-1 border rounded" />
              <input id="password" type="password" placeholder="비밀번호" class="p-1 border rounded" />
              <button id="btn-login" class="badge">로그인</button>
            `;
            authArea.appendChild(form);
            form.querySelector('#btn-login').addEventListener('click', async () => {
              const email = form.querySelector('#email').value;
              const password = form.querySelector('#password').value;
              if (!email || !password) return alert('이메일과 비밀번호를 입력하세요');
              const { error } = await supabase.auth.signInWithPassword({ email, password });
              if (error) return alert('로그인 오류: ' + error.message);
              await renderAuth();
              await loadEmployees();
              loadDayDashboard();
            });
          } else {
            const div = document.createElement('div');
            div.innerHTML = `<span>${user.email}</span> <button id="btn-logout" class="badge">로그아웃</button>`;
            authArea.appendChild(div);
            div.querySelector('#btn-logout').addEventListener('click', async () => {
              await supabase.auth.signOut();
              await renderAuth();
            });
            // 간단한 수퍼유저 판단: 이메일이 admin@ 로 시작하면 관리자 영역 노출
            if (user.email && user.email.startsWith('admin@')) {
              adminArea.style.display = 'block';
            } else {
              adminArea.style.display = 'none';
            }
          }
        } catch (err) {
          authArea.innerText = 'Auth 초기화 중 오류: ' + err.message;
        }
      }

      // ----------------------
      // Load employees
      // ----------------------
      async function loadEmployees() {
        if (!employeesList) return;
        employeesList.innerText = '로딩중...';
        const { data, error } = await supabase.from('employees').select('*').order('full_name');
        if (error) {
          employeesList.innerText = '로딩 오류: ' + error.message;
          return;
        }
        employeesList.innerHTML = '';
        data.forEach(emp => {
          const el = document.createElement('div');
          el.className = 'employee-item';
          el.innerHTML = `
            <img class="thumb" src="${escapeHtml(emp.thumbnail_url || emp.photo_url || 'https://via.placeholder.com/48')}" alt="thumb" />
            <div style="flex:1;">
              <div><strong>${escapeHtml(emp.full_name)}</strong></div>
              <div class="muted" style="font-size:12px;">${escapeHtml(emp.id)}</div>
            </div>
            <div>
              <button class="select-emp badge" data-id="${emp.id}">선택</button>
              <button class="upload-photo badge" data-id="${emp.id}">사진 업로드</button>
            </div>
          `;
          employeesList.appendChild(el);
        });
        // events
        document.querySelectorAll('.select-emp').forEach(btn => btn.addEventListener('click', (e) => openBookingForEmployee(e.currentTarget.dataset.id)));
        document.querySelectorAll('.upload-photo').forEach(btn => btn.addEventListener('click', (e) => openPhotoUploader(e.currentTarget.dataset.id)));
      }

      // ----------------------
      // Booking UI (간단 플레이스홀더)
      // ----------------------
      function openBookingForEmployee(employeeId) {
        if (!bookingRoot) return;
        bookingRoot.innerHTML = `<div>직원 선택: ${escapeHtml(employeeId)}<div style="margin-top:8px;"><button id="btn-create-booking" class="badge">샘플 예약 생성 (로컬 시뮬)</button></div></div>`;
        const btn = document.getElementById('btn-create-booking');
        if (btn) btn.addEventListener('click', () => alert('샘플 예약 생성은 서버/DB에서 처리하세요.'));
      }

      // Upload photo handler (간단 안내)
      function openPhotoUploader(employeeId) {
        alert('사진 업로드는 Storage 및 Edge Function을 통해 처리하세요. 직원 ID: ' + employeeId);
      }

      // ----------------------
      // Dashboard / Stats placeholders
      // ----------------------
      async function loadDayDashboard() {
        const sel = document.getElementById('selected-date');
        const day = sel ? sel.value : new Date().toISOString().slice(0,10);
        dashboardArea.innerText = `선택된 날짜: ${day} — 현황 로딩 중... (실제 쿼리 구현 필요)`;
        // 실제 구현: supabase.from('bookings').select(...) 등으로 데이터 조회 후 렌더
      }

      document.getElementById('load-stats')?.addEventListener('click', async () => {
        statsArea.innerText = '통계 로딩 중... (구현 필요)';
      });

      document.getElementById('btn-create-sample')?.addEventListener('click', () => {
        if (!confirm('샘플 데이터 생성은 관리자 전용이며, SQL Editor에서 실행하시길 권장합니다. SQL을 복사하시겠습니까?')) return;
        // 복사하여 관리자에게 제공하게 함
        navigator.clipboard?.writeText(REQUIRED_SQL).then(() => {
          initResult.innerText = '관리자용 SQL이 클립보드에 복사되었습니다. SQL Editor에 붙여넣어 실행하세요.';
        }).catch(() => {
          initResult.innerText = '클립보드 복사 실패 — 아래 버튼으로 SQL을 보세요.';
        });
      });

      // 버튼: SQL 보기
      btnShowSql?.addEventListener('click', () => {
        const el = document.getElementById('sql-view');
        el.textContent = REQUIRED_SQL;
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
      });

      // 단순 대시보드 로드 버튼
      document.getElementById('btn-load-dashboard')?.addEventListener('click', loadDayDashboard);

      // 초기 렌더
      await renderAuth();
      await loadEmployees();
      loadDayDashboard();

      // ----------------------
      // 유틸리티
      // ----------------------
      function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      // Expose some functions for debugging in console (optional)
      window.app = {
        supabase,
        loadEmployees,
        loadDayDashboard,
        REQUIRED_SQL
      };
    });
  </script>
</head>
<body>
  <h1>마사지샵 관리 시스템</h1>

  <!-- 인증 -->
  <section id="auth-area" class="col"></section>

  <!-- 상단: 날짜 선택 및 현황 -->
  <section class="col" id="top-col">
    <label>날짜:
      <input id="selected-date" type="date" />
    </label>
    <button id="btn-load-dashboard" class="badge">현황 불러오기</button>
    <hr/>
    <h3>현황판</h3>
    <div id="dashboard-area" class="muted">날짜를 선택하고 '현황 불러오기'를 누르세요.</div>
  </section>

  <!-- 중간: 직원 목록 및 예약 패널 -->
  <section class="col" id="middle-col">
    <h3>직원 목록 (선택)</h3>
    <div id="employees-list" class="muted">로딩중...</div>

    <hr/>
    <h3>예약 / 선택 항목</h3>
    <div id="booking-panel">
      <div id="booking-root">직원을 선택하면 예약 UI가 표시됩니다.</div>
    </div>
  </section>

  <!-- 우측: 통계 및 관리자 -->
  <section class="col" id="right-col">
    <h3>통계</h3>
    <label>범위:
      <select id="stats-range">
        <option value="day">일별</option>
        <option value="week">주별</option>
        <option value="month">월별</option>
      </select>
    </label>
    <button id="load-stats" class="badge">불러오기</button>
    <div id="stats-area" class="muted" style="margin-top:8px;">통계가 여기에 표시됩니다.</div>

    <hr/>
    <div id="admin-area" style="display:none;">
      <h3>관리 (수퍼유저)</h3>
      <div id="db-admin" class="muted">초기화 및 SQL 보기</div>
      <div style="margin-top:8px;">
        <button id="btn-show-sql" class="badge">필요 SQL 보기</button>
        <button id="btn-create-sample" class="badge">샘플 데이터 생성</button>
        <div id="init-result" style="margin-top:8px;"></div>
      </div>
    </div>
  </section>

  <!-- 관리자용: SQL 표시 영역 (기본 숨김) -->
  <section class="col" id="sql-section" style="display:block;">
    <pre id="sql-view" style="display:none; white-space:pre-wrap;"></pre>
  </section>
</body>
</html>
