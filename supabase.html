<!doctype html>
<html lang="ko">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마사지샵 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://lmjtjonlvpqcwdzisijd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtanRqb25sdnBxY3dkemlzaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjY1NDksImV4cCI6MjA3ODcwMjU0OX0.HmfZaxAnaVEEHfLxnlUHxR-PAjrUnFMVWs839xJmKfw";
const THUMBNAIL_EDGE_FUNCTION_URL = "https://lmjtjonlvpqcwdzisijd.functions.supabase.co/employee-thumbnail-generator";
const STORAGE_BUCKET = "employee-photos-thumbs"; 
</script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&amp;family=Noto+Sans+Thai:wght@300;400;500;700&amp;family=Noto+Sans+Vietnamese:wght@300;400;500;700&amp;family=Roboto:wght@300;400;500;700&amp;family=Nanum+Gothic:wght@400;700;800&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        .remaining-time {
            font-size: 2rem;
            font-weight: bold;
            color: #ef4444;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            overflow-y: auto;
        }
        .selection-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .menu-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .duration-selection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        .selection-item {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .selection-item:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .selection-item.selected {
            border-color: #3b82f6;
            background-color: #3b82f6;
            color: white;
        }
        .edit-row {
            background-color: #f3f4f6;
        }
        .selected-staff-info {
            background-color: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .menu-row {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .required-label::after {
            content: " *";
            color: red;
            font-weight: bold;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-100 min-h-full"><div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
   <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
    <div class="text-center mb-8">
     <h1 class="text-3xl font-bold text-gray-800" data-translate="title">마사지샵 관리 시스템</h1>
     <div class="w-20 h-1 bg-blue-500 mx-auto"></div>
    </div><div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">언어 선택 / Language / ภาษา / Ngôn ngữ</label>
     <div class="grid grid-cols-4 gap-2"><button onclick="setLanguage('ko')" class="bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600" id="langKo">한국어</button> <button onclick="setLanguage('en')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langEn">English</button> <button onclick="setLanguage('th')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langTh">ไทย</button> <button onclick="setLanguage('vi')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langVi">Tiếng Việt</button>
     </div>
    </div>
    <div class="space-y-4">
     <div><label class="block text-sm font-medium text-gray-700 mb-2" data-translate="username">아이디</label> <input type="text" id="loginUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="usernameInput">
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2" data-translate="password">비밀번호</label> <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="passwordInput">
     </div><button onclick="processLogin()" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200" data-translate="login">로그인</button>
    </div>
   </div>
  </div><div id="mainScreen" class="container mx-auto p-6" style="display: none;"><div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
     <div>
      <h1 class="text-3xl font-bold text-gray-800" data-translate="title">마사지 관리 프로그램</h1>
      <p id="shopName" class="text-lg text-gray-600 mt-1"></p>
     </div>
     <div class="flex gap-2"><button onclick="showLanguageModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="changeLanguage">언어 변경</button> <button onclick="showFontModal()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600" data-translate="changeFont">폰트 변경</button> <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" data-translate="logout">로그아웃</button>
     </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
     <div class="text-center"><label class="block text-sm font-medium mb-2" data-translate="todayDate">오늘 날짜</label>
      <div class="flex gap-2"><input type="date" id="currentDate" class="border rounded px-3 py-2 flex-1"> <button onclick="confirmDateChange()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="confirmDate">확인</button>
      </div>
     </div>
     <div class="text-center"><label class="block text-sm font-medium mb-2" data-translate="currentTime">현재 시간</label>
      <div id="currentTime" class="text-xl font-bold text-blue-600"></div>
     </div>
    </div>
   </div><div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6"><button onclick="showDashboard()" class="bg-blue-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-blue-600" data-translate="dashboard">현황판</button> <button onclick="showOrder()" class="bg-indigo-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-indigo-600" data-translate="order">순번</button> <button onclick="showReservation()" class="bg-green-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-green-600" data-translate="reservation">예약</button> <button onclick="showStatistics()" class="bg-purple-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-purple-600" data-translate="statistics">통계</button> <button onclick="showDBManagement()" class="bg-orange-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-orange-600" data-translate="dbManagement">DB 관리</button>
   </div><div id="orderSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="orderManagement">순번 관리</h2>
    <div class="mb-4"><button onclick="saveStaffOrder()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="saveOrder">순번 저장</button>
    </div>
    <div class="overflow-x-auto">
     <table class="w-full border-collapse border border-gray-300">
      <thead>
       <tr class="bg-gray-100">
        <th class="border border-gray-300 p-2" data-translate="staffName">직원명</th>
        <th class="border border-gray-300 p-2" data-translate="status">상태</th>
        <th class="border border-gray-300 p-2" data-translate="orderNumber">순번</th>
       </tr>
      </thead>
      <tbody id="orderTable">
      </tbody>
     </table>
    </div>
    <div class="mt-4 text-sm text-gray-600" data-translate="orderZeroVacationNote">
     * 순번 0은 휴가로 처리됩니다.
    </div>
   </div><div id="dashboardSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="dashboard">현황판</h2>
    <div class="overflow-x-auto">
     <table class="w-full border-collapse border border-gray-300">
      <thead>
       <tr class="bg-gray-100">
        <th class="border border-gray-300 p-2" data-translate="staff">직원명</th>
        <th class="border border-gray-300 p-2" data-translate="menu">메뉴</th>
        <th class="border border-gray-300 p-2" data-translate="duration">시간</th>
        <th class="border border-gray-300 p-2" data-translate="startTime">시작시간</th>
        <th class="border border-gray-300 p-2" data-translate="endTime">끝시간</th>
        <th class="border border-gray-300 p-2" data-translate="remainingTime">남은시간</th>
        <th class="border border-gray-300 p-2" data-translate="price">가격</th>
        <th class="border border-gray-300 p-2" data-translate="commission">커미션</th>
        <th class="border border-gray-300 p-2" data-translate="roomNumber">방번호</th>
        <th class="border border-gray-300 p-2" data-translate="actions">작업</th>
       </tr>
      </thead>
      <tbody id="dashboardTable">
      </tbody>
     </table>
    </div>
   </div><div id="reservationSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="reservation">예약</h2><div class="mb-6"><label class="block text-sm font-medium mb-2 required-label" data-translate="selectStaff">직원 선택</label>
     <div id="staffSelectionContainer">
      <div id="staffSelection" class="selection-grid"></div>
      <div id="selectedStaffInfo" class="selected-staff-info" style="display: none;">
       <div class="flex justify-between items-center">
        <div>
         <h4 class="font-bold text-lg">선택된 직원: <span id="selectedStaffName"></span></h4>
         <p class="text-sm text-gray-600">순번: <span id="selectedStaffOrder"></span></p>
        </div><button onclick="changeStaff()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">직원 변경</button>
       </div>
      </div>
     </div>
    </div><div id="menuListContainer" style="display: none;">
     <div class="flex justify-between items-center mb-4"><label class="block text-sm font-medium required-label">메뉴 목록</label> <button onclick="addMenuRow()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center gap-2"> <span class="text-lg">+</span> 메뉴 추가 </button>
     </div>
     <div id="menuRows"></div><div class="mt-6 p-4 bg-gray-100 rounded">
      <div class="grid grid-cols-2 gap-4">
       <div>
        <strong data-translate="totalPrice">총 가격:</strong> <span id="totalPrice">0</span><span id="totalPriceCurrency"></span>
       </div>
       <div>
        <strong data-translate="totalCommission">총 커미션:</strong> <span id="totalCommission">0</span><span id="totalCommissionCurrency"></span>
       </div>
      </div>
     </div><div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div><label class="block text-sm font-medium mb-2" data-translate="startTime">시작 시간 (선택사항)</label> <input type="time" id="reservationStartTime" class="w-full border rounded px-3 py-2" onchange="updateAllMenuTimes()">
      </div>
      <div><label class="block text-sm font-medium mb-2" data-translate="roomNumber">방번호 (선택사항)</label> <select id="reservationRoom" class="w-full border rounded px-3 py-2"> <option value="" data-translate="selectRoom">방 선택</option> </select>
      </div>
      <div><label class="block text-sm font-medium mb-2" data-translate="customerName">고객명 (선택사항)</label> <input type="text" id="reservationCustomer" class="w-full border rounded px-3 py-2" data-translate-placeholder="enterCustomerName">
      </div>
     </div><div id="menuTimeSettings" class="mt-6" style="display: none;">
      <h4 class="font-bold mb-3">메뉴별 시간 설정</h4>
      <div id="menuTimeList" class="space-y-3">
      </div>
     </div><button onclick="addReservation()" class="mt-6 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600" data-translate="addReservation">예약 추가</button>
    </div>
   </div><div id="statisticsSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="statistics">통계</h2>
    <div class="mb-4 flex gap-4 flex-wrap"><button onclick="showDailyStats()" id="dailyStatsBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="daily">일간</button> <button onclick="showWeeklyStats()" id="weeklyStatsBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400" data-translate="weekly">주간</button> <button onclick="showMonthlyStats()" id="monthlyStatsBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400" data-translate="monthly">월간</button> <button onclick="showMenuSales()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600" data-translate="monthlyMenuSales">월간 메뉴 매출</button> <button onclick="showMonthlySalesChart()" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600" data-translate="monthlySalesChart">월간 매출 그래프</button> <button onclick="downloadExcel()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" data-translate="download">다운로드</button>
    </div><div class="mb-6 p-4 bg-gray-50 rounded"><div id="dailyDateSelection" class="mb-4"><label class="block text-sm font-medium mb-2" data-translate="selectDate">날짜 선택</label> <input type="date" id="statsDate" class="border rounded px-3 py-2" onchange="updateStats()">
     </div><div id="rangeDateSelection" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display: none;">
      <div><label class="block text-sm font-medium mb-2" data-translate="startDate">시작 날짜</label> <input type="date" id="statsStartDate" class="w-full border rounded px-3 py-2" onchange="autoSetEndDate()">
      </div>
      <div><label class="block text-sm font-medium mb-2" data-translate="endDate">끝 날짜</label> <input type="date" id="statsEndDate" class="w-full border rounded px-3 py-2" onchange="updateStats()">
      </div>
     </div><div id="quickDateSelection" class="mt-3 flex gap-2 flex-wrap" style="display: none;"><button onclick="setThisWeek()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200" data-translate="thisWeek">이번 주</button> <button onclick="setLastWeek()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200" data-translate="lastWeek">지난 주</button> <button onclick="setThisMonth()" class="bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200" data-translate="thisMonth">이번 달</button> <button onclick="setLastMonth()" class="bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200" data-translate="lastMonth">지난 달</button>
     </div>
    </div><div id="chartContainer" class="mb-6" style="display: none;">
     <canvas id="statsChart" width="800" height="400"></canvas>
    </div><div class="mb-6">
     <h3 class="text-lg font-bold mb-2" data-translate="staffStatisticsTitle">직원별 통계</h3>
     <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300">
       <thead>
        <tr class="bg-gray-100">
         <th class="border border-gray-300 p-2" data-translate="staff">마사지사</th>
         <th class="border border-gray-300 p-2" data-translate="totalPrice">총 가격</th>
         <th class="border border-gray-300 p-2" data-translate="totalCommission">총 커미션</th>
        </tr>
       </thead>
       <tbody id="statsTable">
       </tbody>
      </table>
     </div>
    </div><div class="mb-6">
     <h3 class="text-lg font-bold mb-2" data-translate="paymentMethodStatisticsTitle">입금방식별 통계</h3>
     <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300">
       <thead>
        <tr class="bg-gray-100">
         <th class="border border-gray-300 p-2" data-translate="paymentMethodColumn">입금방식</th>
         <th class="border border-gray-300 p-2" data-translate="amountColumn">금액</th>
        </tr>
       </thead>
       <tbody id="paymentStatsTable">
       </tbody>
      </table>
     </div>
    </div>
    <div class="p-4 bg-gray-100 rounded">
     <div class="grid grid-cols-3 gap-4">
      <div>
       <strong data-translate="grandTotal">총 금액(QR팁 제외):</strong> <span id="grandTotalPrice">0</span><span id="grandTotalCurrency"></span>
      </div>
      <div>
       <strong data-translate="grandTotalCommission">총 커미션:</strong> <span id="grandTotalCommission">0</span><span id="grandTotalCommissionCurrency"></span>
      </div>
      <div>
       <strong data-translate="profit">수익:</strong> <span id="totalProfit">0</span><span id="totalProfitCurrency"></span>
      </div>
     </div>
    </div>
   </div><div id="dbManagementSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="dbManagement">DB 관리</h2><div class="mb-6 p-4 bg-gray-100 rounded">
     <h3 class="text-lg font-bold mb-2" data-translate="dataBackupRestoreTitle">데이터 백업 및 복원</h3>
     <div class="grid grid-cols-2 gap-4">
      <div>
       <h4 class="font-semibold mb-2" data-translate="backupButton">백업</h4>
       <div class="flex gap-2 flex-wrap"><button onclick="showLocalBackupDialog()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm" data-translate="localBackupButton">로컬 백업</button> <button onclick="showGoogleBackupDialog()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" data-translate="googleBackupButton">구글 백업</button>
       </div>
      </div>
      <div>
       <h4 class="font-semibold mb-2" data-translate="restoreButton">복원</h4>
       <div class="flex gap-2 flex-wrap"><input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)"> <button onclick="showLocalRestoreDialog()" class="bg-orange-600 text-white px-3 py-2 rounded hover:bg-orange-700 text-sm" data-translate="localRestoreButton">로컬 복원</button> <button onclick="showGoogleRestoreDialog()" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm" data-translate="googleRestoreButton">구글 복원</button>
       </div>
      </div>
     </div>
     <div class="mt-4"><button onclick="exportAllDataExcel()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700" data-translate="exportAllDataButton">전체 데이터 엑셀 내보내기</button>
     </div>
    </div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4"><button onclick="manageMenus()" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600" data-translate="menuManagement">메뉴 관리</button> <button onclick="manageStaff()" class="bg-green-500 text-white py-3 px-4 rounded hover:bg-green-600" data-translate="staffManagement">직원 관리</button> <button onclick="manageRooms()" class="bg-purple-500 text-white py-3 px-4 rounded hover:bg-purple-600" data-translate="roomManagement">방 관리</button> <button onclick="manageCustomers()" class="bg-orange-500 text-white py-3 px-4 rounded hover:bg-orange-600" data-translate="customerManagement">고객 관리</button> <button onclick="manageCurrency()" class="bg-pink-500 text-white py-3 px-4 rounded hover:bg-pink-600" data-translate="currencyManagement">화폐 단위</button> <button onclick="managePaymentMethods()" class="bg-yellow-500 text-white py-3 px-4 rounded hover:bg-yellow-600" data-translate="paymentMethodManagement">입금방식 관리</button> <button onclick="manageGuarantee()" class="bg-teal-500 text-white py-3 px-4 rounded hover:bg-teal-600">Guarantee 관리</button>
     <div id="superAdminButtons" style="display: none;"><button onclick="manageAdmins()" class="bg-red-500 text-white py-3 px-4 rounded hover:bg-red-600" data-translate="adminManagement">관리자 관리</button>
     </div>
    </div>
   </div>
  </div><div id="paymentModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4" data-translate="payment">입금 처리</h3>
    <div id="paymentMethods" class="space-y-4 mb-4">
    </div>
    <div class="mb-4"><strong data-translate="totalAmount">총 금액:</strong> <span id="paymentTotalAmount">0</span><span id="paymentCurrency"></span>
    </div>
    <div class="mb-4"><strong data-translate="enteredAmount">입력된 금액:</strong> <span id="paymentEnteredAmount">0</span><span id="paymentEnteredCurrency"></span>
    </div>
    <div class="flex gap-2"><button onclick="processPayment()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-translate="confirm">확인</button> <button onclick="closePaymentModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="cancel">취소</button>
    </div>
   </div>
  </div><div id="managementModal" class="modal">
   <div class="modal-content">
    <h3 id="managementTitle" class="text-xl font-bold mb-4"></h3>
    <div id="managementContent"></div><button onclick="closeManagementModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="close">닫기</button>
   </div>
  </div><div id="languageModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">언어 선택 / Language / ภาษา / Ngôn ngữ</h3>
    <div class="grid grid-cols-2 gap-4"><button onclick="setLanguageAndClose('ko')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">한국어</button> <button onclick="setLanguageAndClose('en')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">English</button> <button onclick="setLanguageAndClose('th')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">ไทย</button> <button onclick="setLanguageAndClose('vi')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">Tiếng Việt</button>
    </div><button onclick="closeLanguageModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">닫기</button>
   </div>
  </div><div id="fontModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4" data-translate="fontSelection">폰트 선택</h3><div class="mb-6 p-4 bg-gray-50 rounded">
     <h4 class="font-bold mb-3" data-translate="fontSize">폰트 크기</h4>
     <div class="grid grid-cols-5 gap-2"><button onclick="setFontSize('small')" id="fontSizeSmall" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeSmall">작게</button> <button onclick="setFontSize('normal')" id="fontSizeNormal" class="bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600" data-translate="fontSizeNormal">보통</button> <button onclick="setFontSize('large')" id="fontSizeLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeLarge">크게</button> <button onclick="setFontSize('xlarge')" id="fontSizeXLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeXLarge">매우 크게</button> <button onclick="setFontSize('xxlarge')" id="fontSizeXXLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeXXLarge">최대</button>
     </div>
     <div class="mt-2 text-sm text-gray-600" data-translate="fontSizePreview"><span id="fontSizePreview">미리보기 텍스트 - Preview Text - ตัวอย่างข้อความ - Văn bản xem trước</span>
     </div>
    </div><div class="mb-4">
     <h4 class="font-bold mb-3" data-translate="fontFamily">폰트 종류</h4>
     <div class="grid grid-cols-1 gap-3"><button onclick="setFontFamily('Arial')" id="fontFamilyArial" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600" style="font-family: Arial;">Arial (기본)</button> <button onclick="setFontFamily('Noto Sans KR')" id="fontFamilyNotoKR" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans KR', sans-serif;">Noto Sans KR (한글 최적화)</button> <button onclick="setFontFamily('Malgun Gothic')" id="fontFamilyMalgun" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Malgun Gothic', sans-serif;">맑은 고딕</button> <button onclick="setFontFamily('Nanum Gothic')" id="fontFamilyNanum" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Nanum Gothic', sans-serif;">나눔고딕</button> <button onclick="setFontFamily('Roboto')" id="fontFamilyRoboto" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Roboto', sans-serif;">Roboto (영문 최적화)</button> <button onclick="setFontFamily('Noto Sans Thai')" id="fontFamilyThai" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans Thai', sans-serif;">Noto Sans Thai (태국어)</button> <button onclick="setFontFamily('Noto Sans Vietnamese')" id="fontFamilyVietnamese" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans Vietnamese', sans-serif;">Noto Sans Vietnamese (베트남어)</button>
     </div>
    </div>
    <div class="flex gap-2"><button onclick="applyFontSettings()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-translate="apply">적용</button> <button onclick="closeFontModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="close">닫기</button>
    </div>
   </div>
  </div><div id="googleLoginModal" class="modal">
   <div class="modal-content">
    <h3 class="text-xl font-bold mb-4">구글 계정 로그인</h3>
    <div class="space-y-4">
     <div><label class="block text-sm font-medium mb-2">구글 이메일:</label> <input type="email" id="googleEmail" class="w-full border rounded px-3 py-2" placeholder="example@gmail.com">
     </div>
     <div><label class="block text-sm font-medium mb-2">구글 비밀번호:</label> <input type="password" id="googlePassword" class="w-full border rounded px-3 py-2" placeholder="비밀번호 입력">
     </div>
     <div class="text-sm text-gray-600">
      * 실제 구글 계정 정보를 입력하세요. 백업/복원을 위해 구글 드라이브에 접근합니다.
     </div>
    </div>
    <div class="flex gap-2 mt-4"><button id="googleLoginConfirm" onclick="processGoogleLogin()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">로그인</button> <button onclick="closeGoogleLoginModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">취소</button>
    </div>
   </div>
  </div>
  <script>
        // =========================================================================
        // 1. Supabase 클라이언트 초기화 및 연결 함수
        // =========================================================================
        // [수정 완료]: 사용자님이 제공하신 정확한 키를 다시 적용했습니다.
        const SUPABASE_URL = 'https://nzlqloymzuvsysbghczdz.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56bHFsb3ltenV2c3lzYmhjemR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NjIxODQsImV4cCI6MjA3ODUzODE4NH0.X5-7pB7f4gtPI_wMCtS_J-kksPVGGMKYGxFCi2Edp_Q';

        // Supabase 클라이언트 생성
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase Client Initialized!');


        // =========================================================================
        // 2. 데이터 조회 로직 (기존 localStorage.getItem 대체 함수들)
        // =========================================================================

        /**
         * 메뉴 데이터 로드 함수 (menus 테이블 조회)
         * @returns {Array} 메뉴 목록
         */
        async function getMenusData() {
            const { data: menus, error } = await supabase
                .from('menus')
                .select('id, name, prices') 
                .order('id', { ascending: true }); 

            if (error) {
                console.error('Error fetching menus data:', error.message);
                return [];
            }
            return menus;
        }

        /**
         * 직원 데이터 로드 함수 (staff 테이블 조회)
         * @returns {Array} 직원 목록
         */
        async function getStaffData() {
            const { data: staff, error } = await supabase
                .from('staff')
                .select('*')
                .order('name', { ascending: true }); 

            if (error) {
                console.error('Error fetching staff data:', error.message);
                return [];
            }
            return staff;
        }

        /**
         * 방 데이터 로드 함수 (rooms 테이블 조회)
         * @returns {Array} 방 목록
         */
        async function getRoomsData() {
            const { data: rooms, error } = await supabase
                .from('rooms')
                .select('*')
                .order('room_number', { ascending: true }); 

            if (error) {
                console.error('Error fetching rooms data:', error.message);
                // 기존 로직을 위해 'id'와 'roomNumber'로 변환
                return rooms ? rooms.map(r => ({id: r.id, roomNumber: r.room_number, capacity: r.capacity})) : [];
            }
            return rooms ? rooms.map(r => ({id: r.id, roomNumber: r.room_number, capacity: r.capacity})) : [];
        }

        /**
         * 입금 방식 데이터 로드 함수 (payment_methods 테이블 조회)
         * @returns {Array} 입금 방식 목록
         */
        async function getPaymentMethodsData() {
            const { data: methods, error } = await supabase
                .from('payment_methods')
                .select('id, name')
                .order('id', { ascending: true }); 

            if (error) {
                console.error('Error fetching payment methods data:', error.message);
                return [];
            }
            return methods;
        }

        /**
         * 예약 데이터 로드 함수 (reservations 테이블 조회)
         * @param {string} date - 조회할 날짜 (YYYY-MM-DD)
         * @returns {Array} 예약 목록
         */
        async function getReservationsData(date) {
            const { data: reservations, error } = await supabase
                .from('reservations')
                .select('*')
                .eq('date', date); // 날짜 필터링

            if (error) {
                console.error('Error fetching reservations data:', error.message);
                return [];
            }
            return reservations;
        }


        // =========================================================================
        // 3. 예약 저장 로직 (기존 localStorage.setItem 대체)
        // =========================================================================

        /**
         * 새로운 예약/작업을 reservations 테이블에 저장합니다.
         * @param {Object} reservationData - 예약에 필요한 데이터 객체 (배열)
         * @returns {Object|null} - 저장된 데이터 객체 또는 null
         */
        async function saveNewReservations(reservationsArray) {
            // reservationsArray의 각 객체를 DB 스키마에 맞게 변환
            const transformedReservations = reservationsArray.map(r => ({
                date: r.date,
                staff_id: r.staffId, 
                menu_id: r.menuId,
                duration: r.duration,
                start_time: r.startTime,
                room_id: r.roomId || null, 
                customer_name: r.customerName || null,
                price: r.price,
                commission: r.commission,
                paid: r.paid,
                payment_details: r.paymentDetails || {},
                menu_order: r.menuOrder,
                is_multi_menu: r.isMultiMenu,
                // created_at 및 updated_at은 Supabase가 자동으로 처리
            }));

            const { data, error } = await supabase
                .from('reservations')
                .insert(transformedReservations)
                .select(); 

            if (error) {
                console.error('Error saving new reservations:', error.message);
                alert('예약 저장에 실패했습니다. 오류: ' + error.message);
                return null;
            }
            
            console.log(`${data.length} Reservations successfully saved:`, data);
            return data; 
        }

        // =========================================================================
        // 4. 예약 삭제 로직
        // =========================================================================

        /**
         * 예약 데이터를 삭제합니다.
         * @param {number} id - 삭제할 예약 ID
         * @returns {boolean} - 성공 여부
         */
        async function deleteReservationFromDB(id) {
            const { error } = await supabase
                .from('reservations')
                .delete()
                .eq('id', id);

            if (error) {
                console.error('Error deleting reservation:', error.message);
                alert('예약 삭제에 실패했습니다. 오류: ' + error.message);
                return false;
            }
            return true;
        }
        
        // =========================================================================
        // 5. 예약 업데이트 로직
        // =========================================================================
        
        /**
         * 예약 데이터를 업데이트합니다.
         * @param {number} id - 업데이트할 예약 ID
         * @param {Object} updateData - 업데이트할 데이터 객체
         * @returns {Object|null} - 업데이트된 데이터 객체 또는 null
         */
        async function updateReservationInDB(id, updateData) {
             const { data, error } = await supabase
                .from('reservations')
                .update(updateData)
                .eq('id', id)
                .select();

            if (error) {
                console.error('Error updating reservation:', error.message);
                alert('예약 업데이트에 실패했습니다. 오류: ' + error.message);
                return null;
            }
            return data[0];
        }

        // =========================================================================
        // 6. 순번(Staff Order) 데이터 로드 및 저장
        //    (DB 구조 변경 전까지는 localStorage 유지)
        // =========================================================================

        // 순번 키 생성 함수는 그대로 유지
        function getDailyStaffOrderKey(date) {
            return `${currentAdmin.username}_staffOrder_${date}`;
        }
        
        // 순번 로드 함수는 기존 로직을 사용 (DB 통합 시 변경 예정)
        // function loadStaffOrder() { ... }
        // function saveStaffOrder() { ... }


        // 전역 변수
        let currentLanguage = 'ko';
        let currentFont = 'Arial';
        let currentFontSize = 'normal';
        let selectedFontFamily = 'Arial';
        let selectedFontSize = 'normal';
        let currentAdmin = null;
        let currentPaymentReservationId = null;
        let selectedStaff = null;
        let menuRowCounter = 0;
        let menuRows = [];

        // 번역 데이터 (생략)

        // 초기화
        async function initializeApp() {
            try {
                // Supabase에서는 initializeGlobalData()와 initializeAdminData() 대신
                // 로그인 시 필요한 최소한의 데이터를 메모리에 로드하거나,
                // 필요한 시점에 Supabase에서 데이터를 가져와야 합니다.
                // 임시로 localStorage에서 언어 및 폰트 설정만 로드합니다.
                // initializeGlobalData(); // ❌ Supabase 사용 시 주석 처리 또는 제거

                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                const currentDateElement = document.getElementById('currentDate');
                if (currentDateElement) {
                    currentDateElement.value = new Date().toISOString().split('T')[0];
                }
                
                // 저장된 폰트 설정 복원
                try {
                    const savedFont = localStorage.getItem('selectedFont');
                    const savedFontSize = localStorage.getItem('selectedFontSize');
                    if (savedFont) {
                        currentFont = savedFont;
                        selectedFontFamily = savedFont;
                    }
                    if (savedFontSize) {
                        currentFontSize = savedFontSize;
                        selectedFontSize = savedFontSize;
                    }
                    applyFontSettings();
                } catch (fontError) {
                    console.log('폰트 설정 복원 오류:', fontError);
                }
                
                // 새로고침시 로그인 상태 복원
                try {
                    const savedAdmin = localStorage.getItem('currentAdmin');
                    
                    // Supabase Auth 세션 확인
                    const { data: { session } } = await supabase.auth.getSession();

                    if (session) {
                        // Supabase 세션이 유효하면 localStorage의 admin 정보 업데이트
                        if (!savedAdmin || JSON.parse(savedAdmin).username !== session.user.email) {
                            currentAdmin = { 
                                username: session.user.email,
                                type: 'normal', 
                                shopName: 'Supabase 관리자 화면 (DB 연동)',
                                id: session.user.id // Supabase user ID 저장
                            };
                            localStorage.setItem('currentAdmin', JSON.stringify(currentAdmin));
                        } else {
                             currentAdmin = JSON.parse(savedAdmin);
                        }
                        
                        // 관리자 데이터 유효성 검사 및 화면 로드
                        if (currentAdmin && currentAdmin.username) {
                            // initializeAdminData(); // ❌ Supabase 사용 시 주석 처리 또는 제거
                            document.getElementById('loginScreen').style.display = 'none';
                            document.getElementById('mainScreen').style.display = 'block';
                            
                            // 상점명 설정
                            const shopNameElement = document.getElementById('shopName');
                            if (shopNameElement) {
                                // 임시로 일반 관리자 화면으로 처리
                                shopNameElement.textContent = currentAdmin.shopName || '관리자 화면 (DB 연동)';
                                const superAdminButtons = document.getElementById('superAdminButtons');
                                if (superAdminButtons) {
                                    superAdminButtons.style.display = 'none';
                                }
                            }
                            
                            loadReservationData();
                            showDashboard();
                        } else {
                            // Supabase 세션은 있으나 local Admin 정보가 유효하지 않은 경우
                            localStorage.removeItem('currentAdmin');
                            currentAdmin = null;
                            await supabase.auth.signOut(); // 세션도 삭제
                        }
                    } else if (savedAdmin) {
                        // LocalStorage에 Admin 정보는 있지만 Supabase 세션이 없는 경우 -> 로그인 화면
                        localStorage.removeItem('currentAdmin');
                        currentAdmin = null;
                    }
                } catch (adminError) {
                    console.log('관리자 상태 복원 오류:', adminError);
                    // 오류 발생시 로그아웃 상태로 초기화
                    localStorage.removeItem('currentAdmin');
                    currentAdmin = null;
                    try {
                       await supabase.auth.signOut();
                    } catch (e) {
                        console.error('Supabase signOut error:', e);
                    }
                }
            } catch (error) {
                console.error('앱 초기화 중 오류:', error);
                // 기본 상태로 초기화
                try {
                    // initializeGlobalData(); // ❌ Supabase 사용 시 주석 처리 또는 제거
                    updateCurrentTime();
                } catch (fallbackError) {
                    console.error('기본 초기화도 실패:', fallbackError);
                }
            }
        }

        // 전역 데이터 초기화 (관리자 계정만)
        function initializeGlobalData() {
            // ❌ Supabase 인증 및 데이터베이스를 사용하므로, 이 함수는 사용하지 않습니다. ❌
        }

        // 관리자별 데이터베이스 키 생성
        function getAdminKey(dataType) {
            // 임시로 localStorage 키 구조는 유지하되, 나중에 DB 테이블 이름으로 대체될 예정
            return `${currentAdmin.username}_${dataType}`;
        }

        // 관리자별 데이터 초기화
        function initializeAdminData() {
            // ❌ Supabase 인증 및 데이터베이스를 사용하므로, 이 함수는 사용하지 않습니다. ❌
        }

        // 로그인 처리
        async function processLogin() {
            try {
                // Supabase는 email/password 기반 인증을 사용합니다.
                const email = document.getElementById('loginUsername').value; 
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    alert('아이디(이메일)와 비밀번호를 입력해주세요.');
                    return;
                }
                
                // 1. Supabase Auth를 사용하여 로그인 시도
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email, 
                    password: password,
                });

                if (error) {
                    console.error('Login Error:', error.message);
                    // ⚠️ 에러 발생 시 네트워크 상태 및 Supabase 서비스 상태를 확인하도록 안내
                    alert('로그인에 실패했습니다. (아이디 또는 비밀번호를 확인해주세요.)\n\n' +
                          '에러 메시지: ' + error.message + '\n\n' +
                          '✅ [확인 사항]:\n' +
                          '1. 아이디 필드에 Supabase Auth에 등록된 이메일을 입력했는지 확인해주세요.\n' +
                          '2. Supabase 대시보드에서 해당 이메일/비밀번호로 등록된 계정인지 확인해주세요.');
                    return;
                }

                if (data.user) {
                    // 2. 로그인 성공 시 처리
                    
                    // Supabase user 정보를 기반으로 currentAdmin 객체 설정
                    currentAdmin = { 
                        username: data.user.email, 
                        type: 'normal', 
                        shopName: 'Supabase 관리자 화면 (DB 연동)', 
                        id: data.user.id
                    };
                    localStorage.setItem('currentAdmin', JSON.stringify(currentAdmin));

                    // 3. 메인 화면 로드
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainScreen').style.display = 'block';
                    
                    // 상점명 설정
                    const shopNameElement = document.getElementById('shopName');
                    shopNameElement.textContent = currentAdmin.shopName;
                    
                    // 데이터 로드 및 대시보드 표시
                    loadReservationData();
                    showDashboard();
                } else {
                    alert('로그인에 실패했습니다. (알 수 없는 오류)');
                }
            } catch (error) {
                console.error('로그인 처리 중 치명적인 오류:', error);
                alert('로그인 처리 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
            }
        }

        // 로그아웃
        async function logout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                // Supabase 세션 종료
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Supabase Logout Error:', error);
                }
                
                currentAdmin = null;
                localStorage.removeItem('currentAdmin');
                selectedStaff = null;
                menuRows = [];
                menuRowCounter = 0;
                document.getElementById('mainScreen').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                // 모든 섹션 숨기기
                hideAllSections();
                
                // 언어를 한국어로 초기화
                setLanguage('ko');
            }
        }

        // 언어 설정
        function setLanguage(lang) {
            currentLanguage = lang;
            
            // 언어 버튼 스타일 업데이트
            document.getElementById('langKo').className = lang === 'ko' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            document.getElementById('langEn').className = lang === 'en' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            document.getElementById('langTh').className = lang === 'th' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            document.getElementById('langVi').className = lang === 'vi' ? 'bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600' : 'bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400';
            
            updateTranslations();
            
            // 메인 화면이 표시된 경우에만 데이터 로드
            if (document.getElementById('mainScreen').style.display === 'block') {
                loadReservationData();
                showDashboard();
            }
        }

        function updateTranslations() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'password')) {
                        element.placeholder = translations[currentLanguage][key];
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });
            
            // placeholder 전용 번역 처리
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
            
            updateCurrencyDisplay();
        }

        // 화폐 단위 표시 업데이트
        function updateCurrencyDisplay() {
            // [TODO: DB에서 화폐 단위 로드 로직 필요]
            const currency = JSON.parse(localStorage.getItem(getAdminKey('currency')) || '{"symbol":"","name":"원"}');
            const currencyElements = document.querySelectorAll('[id$="Currency"]');
            currencyElements.forEach(element => {
                element.textContent = currency.symbol;
            });
        }

        // 시간 업데이트
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            updateDashboardRemainingTime();
        }

        function updateCurrentDate() {
            loadReservationData();
        }

        function confirmDateChange() {
            loadReservationData();
            if (document.getElementById('dashboardSection').style.display === 'block') {
                loadDashboard();
            }
            if (document.getElementById('orderSection').style.display === 'block') {
                loadStaffOrder();
            }
            if (document.getElementById('statisticsSection').style.display === 'block') {
                document.getElementById('statsDate').value = document.getElementById('currentDate').value;
                showDailyStats();
            }
        }

        // 섹션 표시/숨김
        function hideAllSections() {
            const sections = ['dashboardSection', 'orderSection', 'reservationSection', 'statisticsSection', 'dbManagementSection'];
            sections.forEach(section => {
                document.getElementById(section).style.display = 'none';
            });
        }

        function showDashboard() {
            hideAllSections();
            document.getElementById('dashboardSection').style.display = 'block';
            loadDashboard();
        }

        function showReservation() {
            hideAllSections();
            document.getElementById('reservationSection').style.display = 'block';
            resetReservationForm();
            loadReservationData();
        }

        function showStatistics() {
            hideAllSections();
            document.getElementById('statisticsSection').style.display = 'block';
            document.getElementById('statsDate').value = document.getElementById('currentDate').value;
            showDailyStats();
        }

        function showOrder() {
            hideAllSections();
            document.getElementById('orderSection').style.display = 'block';
            loadStaffOrder();
        }

        function showDBManagement() {
            hideAllSections();
            document.getElementById('dbManagementSection').style.display = 'block';
        }

        // 예약 폼 초기화
        function resetReservationForm() {
            selectedStaff = null;
            menuRows = [];
            menuRowCounter = 0;
            
            // UI 초기화
            document.getElementById('staffSelection').style.display = 'block';
            document.getElementById('selectedStaffInfo').style.display = 'none';
            document.getElementById('menuListContainer').style.display = 'none';
            document.getElementById('menuRows').innerHTML = '';
            document.getElementById('reservationStartTime').value = '';
            document.getElementById('reservationRoom').value = '';
            document.getElementById('reservationCustomer').value = '';
            
            // 직원 선택 초기화
            const staffItems = document.querySelectorAll('#staffSelection .selection-item');
            staffItems.forEach(item => {
                item.classList.remove('selected');
            });
            
            updateTotalPrices();
        }

        // 예약 관련 함수
        function loadReservationData() {
            loadStaffSelection();
            loadRoomSelection();
        }

        async function loadStaffSelection() {
            // 직원 데이터 로드 (DB 연동)
            const staff = await getStaffData();
            
            const currentDate = document.getElementById('currentDate').value;
            // 순번 및 예약 데이터는 임시로 localStorage에서 로드하거나, DB 연동 시 변경 필요
            const staffOrder = JSON.parse(localStorage.getItem(getDailyStaffOrderKey(currentDate)) || '{}');
            const reservations = await getReservationsData(currentDate); 
            
            // 퇴사자 제외하고 정직원과 단기고용만 표시
            const activeStaff = staff.filter(s => {
                const status = s.status || '정직원';
                return status !== '퇴사';
            });
            
            // 순번으로 정렬
            activeStaff.sort((a, b) => {
                const orderA = staffOrder[a.id] !== undefined ? staffOrder[a.id] : 1;
                const orderB = staffOrder[b.id] !== undefined ? staffOrder[b.id] : 1;
                if (orderA === 0 && orderB !== 0) return 1;
                if (orderA !== 0 && orderB === 0) return -1;
                if (orderA === 0 && orderB === 0) return 0;
                return orderA - orderB;
            });
            
            const container = document.getElementById('staffSelection');
            container.innerHTML = '';

            activeStaff.forEach(s => {
                const order = staffOrder[s.id] !== undefined ? staffOrder[s.id] : 1;
                const isOnVacation = order === 0;
                const hasReservation = reservations.some(r => 
                    r.date === currentDate && 
                    r.staff_id === s.id && // DB 컬럼명으로 변경
                    !r.paid && 
                    r.start_time // DB 컬럼명으로 변경
                );
                
                const div = document.createElement('div');
                div.className = 'selection-item';
                div.setAttribute('data-staff-id', s.id);
                
                // 상태에 따른 색상 설정
                if (hasReservation) {
                    div.style.backgroundColor = '#9ca3af';
                    div.style.color = 'white';
                    div.style.cursor = 'not-allowed';
                } else if (isOnVacation) {
                    div.style.backgroundColor = '#9ca3af';
                    div.style.color = 'white';
                    div.style.cursor = 'not-allowed';
                } else {
                    div.style.backgroundColor = 'transparent';
                    div.style.color = '#374151';
                    div.style.border = '2px solid #e5e7eb';
                }
                
                const vacationText = translations[currentLanguage].vacationStatus || '휴가';
                div.textContent = `${s.name} (${order === 0 ? vacationText : order})`;
                
                if (!hasReservation && !isOnVacation) {
                    div.onclick = () => selectStaff(s.id, s.name, order, div);
                }
                
                container.appendChild(div);
            });
        }

        function selectStaff(id, name, order, element) {
            selectedStaff = {id, name, order};
            
            // 선택된 직원 정보 표시
            document.getElementById('selectedStaffName').textContent = name;
            document.getElementById('selectedStaffOrder').textContent = order === 0 ? '휴가' : order;
            document.getElementById('selectedStaffInfo').style.display = 'block';
            document.getElementById('staffSelection').style.display = 'none';
            
            // 메뉴 목록 컨테이너 표시 및 첫 번째 메뉴 행 추가
            document.getElementById('menuListContainer').style.display = 'block';
            menuRows = [];
            menuRowCounter = 0;
            document.getElementById('menuRows').innerHTML = '';
            addMenuRow();
        }

        function changeStaff() {
            selectedStaff = null;
            menuRows = [];
            menuRowCounter = 0;
            
            document.getElementById('selectedStaffInfo').style.display = 'none';
            document.getElementById('staffSelection').style.display = 'block';
            document.getElementById('menuListContainer').style.display = 'none';
            document.getElementById('menuRows').innerHTML = '';
            
            updateTotalPrices();
        }

        async function addMenuRow() {
            const menuRowId = ++menuRowCounter;
            const menuRow = {
                id: menuRowId,
                menuId: null,
                menuName: '',
                duration: null,
                price: 0,
                commission: 0,
                startTime: ''
            };
            
            menuRows.push(menuRow);
            
            // 메뉴 데이터 로드 (DB 연동)
            const menus = await getMenusData();
            
            const menuRowDiv = document.createElement('div');
            menuRowDiv.className = 'menu-row';
            menuRowDiv.id = `menuRow_${menuRowId}`;
            
            menuRowDiv.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <h4 class="font-bold">메뉴 ${menuRows.length}</h4>
                    ${menuRows.length > 1 ? `<button onclick="removeMenuRow(${menuRowId})" class="bg-red-500 text-white px-2 py-1 rounded text-sm hover:bg-red-600">× 삭제</button>` : ''}
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">메뉴 선택</label>
                        <div id="menuSelection_${menuRowId}" class="menu-selection-grid">
                            ${menus.map(m => `
                                <div class="selection-item" data-menu-id="${m.id}" onclick="selectMenuForRow(${menuRowId}, ${m.id}, '${m.name}')">
                                    ${m.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="durationContainer_${menuRowId}" style="display: none;">
                        <label class="block text-sm font-medium mb-2">시간 선택</label>
                        <div id="durationSelection_${menuRowId}" class="duration-selection-grid">
                        </div>
                    </div>
                    
                    <div id="priceInfo_${menuRowId}" class="p-3 bg-gray-50 rounded" style="display: none;">
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>가격: <span id="menuPrice_${menuRowId}" class="font-bold">0</span><span class="currency-symbol"></span></div>
                            <div>커미션: <span id="menuCommission_${menuRowId}" class="font-bold">0</span><span class="currency-symbol"></span></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('menuRows').appendChild(menuRowDiv);
            updateCurrencyDisplay();
            updateMenuTimeSettings();
        }

        function removeMenuRow(menuRowId) {
            // 메뉴 행 제거
            const menuRowElement = document.getElementById(`menuRow_${menuRowId}`);
            if (menuRowElement) {
                menuRowElement.remove();
            }
            
            // 배열에서 제거
            menuRows = menuRows.filter(row => row.id !== menuRowId);
            
            // 메뉴 번호 재정렬
            menuRows.forEach((row, index) => {
                const rowElement = document.getElementById(`menuRow_${row.id}`);
                if (rowElement) {
                    const titleElement = rowElement.querySelector('h4');
                    if (titleElement) {
                        titleElement.textContent = `메뉴 ${index + 1}`;
                    }
                }
            });
            
            updateTotalPrices();
            updateMenuTimeSettings();
        }

        async function selectMenuForRow(menuRowId, menuId, menuName) {
            const menuRow = menuRows.find(row => row.id === menuRowId);
            if (!menuRow) return;
            
            // 이전 선택 해제
            const menuSelection = document.getElementById(`menuSelection_${menuRowId}`);
            menuSelection.querySelectorAll('.selection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 현재 선택 표시
            const selectedItem = menuSelection.querySelector(`[data-menu-id="${menuId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // 메뉴 데이터 로드 (DB 연동)
            const menus = await getMenusData();
            const menu = menus.find(m => m.id === menuId);
            
            if (menu) {
                menuRow.menuId = menuId;
                menuRow.menuName = menuName;
                
                // 시간 선택 영역 표시 및 업데이트
                const durationContainer = document.getElementById(`durationContainer_${menuRowId}`);
                const durationSelection = document.getElementById(`durationSelection_${menuRowId}`);
                
                durationContainer.style.display = 'block';
                durationSelection.innerHTML = '';
                
                Object.keys(menu.prices).forEach(duration => {
                    const durationKey = `duration${duration}`;
                    const durationText = translations[currentLanguage][durationKey] || `${duration}분`;
                    
                    const durationDiv = document.createElement('div');
                    durationDiv.className = 'selection-item';
                    durationDiv.setAttribute('data-duration', duration);
                    durationDiv.textContent = durationText;
                    durationDiv.onclick = () => selectDurationForRow(menuRowId, parseInt(duration));
                    
                    durationSelection.appendChild(durationDiv);
                });
                
                // 이전 시간 선택 초기화
                menuRow.duration = null;
                menuRow.price = 0;
                menuRow.commission = 0;
                
                document.getElementById(`menuPrice_${menuRowId}`).textContent = '0';
                document.getElementById(`menuCommission_${menuRowId}`).textContent = '0';
                document.getElementById(`priceInfo_${menuRowId}`).style.display = 'none';
            }
            
            updateTotalPrices();
        }

        async function selectDurationForRow(menuRowId, duration) {
            const menuRow = menuRows.find(row => row.id === menuRowId);
            if (!menuRow || !menuRow.menuId) return;
            
            // 이전 선택 해제
            const durationSelection = document.getElementById(`durationSelection_${menuRowId}`);
            durationSelection.querySelectorAll('.selection-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 현재 선택 표시
            const selectedItem = durationSelection.querySelector(`[data-duration="${duration}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // 메뉴 데이터 로드 (DB 연동)
            const menus = await getMenusData();
            const menu = menus.find(m => m.id === menuRow.menuId);
            
            if (menu && menu.prices[duration]) {
                menuRow.duration = duration;
                // Supabase에서 가져온 prices 필드를 사용
                menuRow.price = menu.prices[duration].price; 
                menuRow.commission = menu.prices[duration].commission;
                
                document.getElementById(`menuPrice_${menuRowId}`).textContent = menuRow.price.toLocaleString();
                document.getElementById(`menuCommission_${menuRowId}`).textContent = menuRow.commission.toLocaleString();
                
                // 가격 정보 표시
                document.getElementById(`priceInfo_${menuRowId}`).style.display = 'block';
            }
            
            updateTotalPrices();
            updateMenuTimeSettings();
        }

        function updateTotalPrices() {
            const totalPrice = menuRows.reduce((sum, row) => sum + row.price, 0);
            const totalCommission = menuRows.reduce((sum, row) => sum + row.commission, 0);
            
            document.getElementById('totalPrice').textContent = totalPrice.toLocaleString();
            document.getElementById('totalCommission').textContent = totalCommission.toLocaleString();
            
            updateCurrencyDisplay();
        }

        // 메뉴별 시간 설정 업데이트
        function updateMenuTimeSettings() {
            const menuTimeSettings = document.getElementById('menuTimeSettings');
            const menuTimeList = document.getElementById('menuTimeList');
            
            if (menuRows.length === 0) {
                menuTimeSettings.style.display = 'none';
                return;
            }
            
            // 완성된 메뉴만 필터링 (메뉴와 시간이 모두 선택된 것)
            const completedMenus = menuRows.filter(row => row.menuId && row.duration);
            
            if (completedMenus.length === 0) {
                menuTimeSettings.style.display = 'none';
                return;
            }
            
            menuTimeSettings.style.display = 'block';
            menuTimeList.innerHTML = '';
            
            completedMenus.forEach((row, index) => {
                const menuTimeDiv = document.createElement('div');
                menuTimeDiv.className = 'flex items-center gap-4 p-3 bg-gray-50 rounded';
                
                // 이전 메뉴의 종료 시간을 기본값으로 계산
                let suggestedTime = '';
                if (index === 0) {
                    // 첫 번째 메뉴는 전체 시작 시간 사용
                    const globalStartTime = document.getElementById('reservationStartTime').value;
                    suggestedTime = globalStartTime || '';
                } else {
                    // 이전 메뉴의 종료 시간 계산
                    const prevMenu = completedMenus[index - 1];
                    if (prevMenu.startTime) {
                        suggestedTime = calculateEndTime(prevMenu.startTime, prevMenu.duration);
                    }
                }
                
                // 현재 저장된 시간이 있으면 그것을 사용, 없으면 제안된 시간 사용
                const currentTime = row.startTime || suggestedTime;
                
                menuTimeDiv.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium">${row.menuName} (${row.duration}분)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm">시작 시간:</label>
                        <input type="time" id="menuTime_${row.id}" value="${currentTime}" 
                               class="border rounded px-2 py-1" 
                               onchange="updateMenuStartTime(${row.id})">
                    </div>
                    <div class="text-sm text-gray-600">
                        종료: <span id="menuEndTime_${row.id}">${currentTime ? calculateEndTime(currentTime, row.duration) : '-'}</span>
                    </div>
                `;
                
                menuTimeList.appendChild(menuTimeDiv);
                
                // 메뉴 행 데이터 업데이트
                row.startTime = currentTime;
            });
        }

        // 개별 메뉴 시작 시간 업데이트
        function updateMenuStartTime(menuRowId) {
            const timeInput = document.getElementById(`menuTime_${menuRowId}`);
            const menuRow = menuRows.find(row => row.id === menuRowId);
            
            if (menuRow && timeInput) {
                menuRow.startTime = timeInput.value;
                
                // 종료 시간 업데이트
                const endTimeSpan = document.getElementById(`menuEndTime_${menuRowId}`);
                if (endTimeSpan) {
                    endTimeSpan.textContent = timeInput.value ? calculateEndTime(timeInput.value, menuRow.duration) : '-';
                }
                
                // 다음 메뉴들의 시간도 자동 업데이트
                updateSubsequentMenuTimes(menuRowId);
            }
        }

        // 후속 메뉴들의 시간 자동 업데이트
        function updateSubsequentMenuTimes(changedMenuRowId) {
            const completedMenus = menuRows.filter(row => row.menuId && row.duration);
            const changedIndex = completedMenus.findIndex(row => row.id === changedMenuRowId);
            
            if (changedIndex === -1) return;
            
            // 변경된 메뉴 이후의 메뉴들 업데이트
            for (let i = changedIndex + 1; i < completedMenus.length; i++) {
                const prevMenu = completedMenus[i - 1];
                const currentMenu = completedMenus[i];
                
                if (prevMenu.startTime) {
                    const newStartTime = calculateEndTime(prevMenu.startTime, prevMenu.duration);
                    currentMenu.startTime = newStartTime;
                    
                    // UI 업데이트
                    const timeInput = document.getElementById(`menuTime_${currentMenu.id}`);
                    const endTimeSpan = document.getElementById(`menuEndTime_${currentMenu.id}`);
                    
                    if (timeInput) {
                        timeInput.value = newStartTime;
                    }
                    if (endTimeSpan) {
                        endTimeSpan.textContent = calculateEndTime(newStartTime, currentMenu.duration);
                    }
                }
            }
        }

        // 전체 시작 시간 변경시 모든 메뉴 시간 업데이트
        function updateAllMenuTimes() {
            const globalStartTime = document.getElementById('reservationStartTime').value;
            const completedMenus = menuRows.filter(row => row.menuId && row.duration);
            
            if (!globalStartTime || completedMenus.length === 0) return;
            
            // 첫 번째 메뉴의 시작 시간을 전체 시작 시간으로 설정
            if (completedMenus.length > 0) {
                completedMenus[0].startTime = globalStartTime;
                
                // 나머지 메뉴들은 순차적으로 계산
                for (let i = 1; i < completedMenus.length; i++) {
                    const prevMenu = completedMenus[i - 1];
                    completedMenus[i].startTime = calculateEndTime(prevMenu.startTime, prevMenu.duration);
                }
                
                // UI 업데이트
                updateMenuTimeSettings();
            }
        }

        async function loadRoomSelection() {
            // 방 데이터 로드 (DB 연동)
            const rooms = await getRoomsData();
            const roomSelect = document.getElementById('reservationRoom');
            const selectRoomText = translations[currentLanguage].selectRoomOption || '방 선택';
            roomSelect.innerHTML = `<option value="">${selectRoomText}</option>`;
            rooms.forEach(r => {
                roomSelect.innerHTML += `<option value="${r.id}">${r.roomNumber}</option>`;
            });
        }

        async function addReservation() {
            if (!selectedStaff) {
                alert('직원을 선택해주세요.');
                return;
            }

            // 모든 메뉴가 완성되었는지 확인
            const incompleteMenus = menuRows.filter(row => !row.menuId || !row.duration);
            if (incompleteMenus.length > 0) {
                alert('모든 메뉴의 선택을 완료해주세요.');
                return;
            }

            const startTime = document.getElementById('reservationStartTime').value;
            const roomId = document.getElementById('reservationRoom').value;
            const customerName = document.getElementById('reservationCustomer').value;

            // 방 정보 로드 (DB 연동)
            const rooms = await getRoomsData();
            const selectedRoom = rooms.find(r => r.id == roomId);

            const reservationsToSave = [];

            // 각 메뉴에 대해 개별 예약 객체 생성
            menuRows.forEach((menuRow, index) => {
                // 개별 메뉴의 시작 시간이 있으면 사용, 없으면 전체 시작 시간 사용
                const menuStartTime = menuRow.startTime || startTime;
                
                const newReservation = {
                    date: document.getElementById('currentDate').value,
                    staffId: selectedStaff.id,
                    staffName: selectedStaff.name,
                    menuId: menuRow.menuId,
                    menuName: menuRow.menuName,
                    duration: menuRow.duration,
                    startTime: menuStartTime,
                    roomId: roomId,
                    roomNumber: selectedRoom ? selectedRoom.roomNumber : '',
                    customerName: customerName,
                    price: menuRow.price,
                    commission: menuRow.commission,
                    paid: false,
                    paymentDetails: {},
                    menuOrder: index + 1, // 메뉴 순서
                    isMultiMenu: menuRows.length > 1 // 다중 메뉴 여부
                };

                reservationsToSave.push(newReservation);
            });

            // DB에 예약 저장
            const savedReservations = await saveNewReservations(reservationsToSave);

            if (savedReservations) {
                 const menuCount = savedReservations.length;
                alert(`${menuCount}개의 메뉴로 예약이 추가되었습니다.`);
                
                // 폼 초기화
                resetReservationForm();
                loadReservationData();
                loadDashboard(); // 대시보드 새로고침
            }
        }

        // 현황판 관련 함수
        async function loadDashboard() {
            const currentDate = document.getElementById('currentDate').value;
            
            // 예약 데이터 로드 (DB 연동)
            const todayReservations = await getReservationsData(currentDate);
            
            // 순번 및 직원 데이터는 임시로 localStorage에서 로드하거나, DB 연동 시 변경 필요
            const staffOrder = JSON.parse(localStorage.getItem(getDailyStaffOrderKey(currentDate)) || '{}');
            const staffList = await getStaffData();

            // 순번 순서로 정렬
            todayReservations.sort((a, b) => {
                const orderA = staffOrder[a.staff_id] || 999; // DB 컬럼명으로 변경
                const orderB = staffOrder[b.staff_id] || 999; // DB 컬럼명으로 변경
                return orderA - orderB;
            });
            
            const tableBody = document.getElementById('dashboardTable');
            tableBody.innerHTML = '';

            todayReservations.forEach(reservation => {
                // DB 컬럼명에 맞게 변수명 조정
                const staffId = reservation.staff_id;
                const startTime = reservation.start_time;
                const duration = reservation.duration;
                const paid = reservation.paid;
                const price = reservation.price;
                const commission = reservation.commission;
                const roomNumber = reservation.roomNumber || reservation.room_number || '-';
                const menuOrder = reservation.menu_order;
                const isMultiMenu = reservation.is_multi_menu;

                const staffInfo = staffList.find(s => s.id === staffId) || { name: '알 수 없음' };
                const staffName = staffInfo.name;
                const menuName = reservation.menuName || '알 수 없음'; // 메뉴명을 DB에서 가져오는 로직 추가 필요

                const row = document.createElement('tr');
                const endTime = calculateEndTime(startTime, duration);
                const remainingMinutes = calculateRemainingTime(startTime, duration, reservation.date);
                
                if (paid) {
                    row.className = 'bg-green-50';
                }
                
                const currency = JSON.parse(localStorage.getItem(getAdminKey('currency')) || '{"symbol":"","name":"원"}');
                
                const staffOrderNum = staffOrder[staffId] !== undefined ? staffOrder[staffId] : 1;
                const vacationText = translations[currentLanguage].vacationStatus || '휴가';
                const staffDisplayName = staffOrderNum === 0 ? `${staffName} (${vacationText})` : `${staffOrderNum}. ${staffName}`;
                
                // 다중 메뉴인 경우 메뉴명에 순서 표시
                const menuDisplayName = isMultiMenu ? 
                    `${menuName} (${menuOrder})` : 
                    menuName;
                
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${staffDisplayName}</td>
                    <td class="border border-gray-300 p-2">${menuDisplayName}</td>
                    <td class="border border-gray-300 p-2">${duration}min</td>
                    <td class="border border-gray-300 p-2">${startTime || '-'}</td>
                    <td class="border border-gray-300 p-2">${startTime ? endTime : '-'}</td>
                    <td class="border border-gray-300 p-2 remaining-time">${paid ? '-' : (startTime ? (remainingMinutes === -1 ? '-' : remainingMinutes + 'min') : '-')}</td>
                    <td class="border border-gray-300 p-2">${price.toLocaleString()}${currency.symbol}</td>
                    <td class="border border-gray-300 p-2">${commission.toLocaleString()}${currency.symbol}</td>
                    <td class="border border-gray-300 p-2">${roomNumber || '-'}</td>
                    <td class="border border-gray-300 p-2">
                        ${paid ? 
                            `<span class="bg-green-500 text-white px-3 py-1 rounded text-sm font-bold">${translations[currentLanguage].paymentCompleteStatus || '입금 완료'}</span>` :
                            `<button onclick="editReservation(${reservation.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm mr-1">${translations[currentLanguage].edit || '수정'}</button>
                             <button onclick="showPaymentModal(${reservation.id})" class="bg-green-500 text-white px-2 py-1 rounded text-sm mr-1">${translations[currentLanguage].payment || '입금'}</button>
                             <button onclick="deleteReservation(${reservation.id})" class="bg-red-500 text-white px-2 py-1 rounded text-sm">${translations[currentLanguage].delete || '삭제'}</button>`
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function calculateEndTime(startTime, duration) {
            if (!startTime) return '-';
            const [hours, minutes] = startTime.split(':').map(Number);
            const startMinutes = hours * 60 + minutes;
            const endMinutes = startMinutes + duration;
            const endHours = Math.floor(endMinutes / 60) % 24; // 24시간제
            const endMins = endMinutes % 60;
            return `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
        }

        function calculateRemainingTime(startTime, duration, reservationDate) {
            if (!startTime) return 0;
            
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            // 예약 날짜가 오늘이 아닌 경우
            if (reservationDate && reservationDate !== currentDate) {
                const reservationDateObj = new Date(reservationDate);
                const currentDateObj = new Date(currentDate);
                
                // 예약 날짜가 과거인 경우 시간이 지났음을 의미
                if (reservationDateObj < currentDateObj) {
                    return -1;
                }
                // 예약 날짜가 미래인 경우 아직 시작되지 않음 (당일이 아닌 미래 날짜는 0)
                if (reservationDateObj > currentDateObj) {
                    return 0;
                }
            }
            
            const [hours, minutes] = startTime.split(':').map(Number);
            const startMinutes = hours * 60 + minutes;
            const endMinutes = startMinutes + duration;
            
            const remaining = endMinutes - currentMinutes;
            return remaining <= 0 ? -1 : remaining; // -1은 시간이 지났음을 의미
        }

        async function updateDashboardRemainingTime() {
            const remainingCells = document.querySelectorAll('.remaining-time');
            const currentDate = document.getElementById('currentDate').value;
            
            // 예약 데이터 로드 (DB 연동)
            const todayReservations = await getReservationsData(currentDate);
            
            // 순번 데이터는 임시로 localStorage에서 로드하거나, DB 연동 시 변경 필요
            const staffOrder = JSON.parse(localStorage.getItem(getDailyStaffOrderKey(currentDate)) || '{}');
            
            // 순번 순서로 정렬
            todayReservations.sort((a, b) => {
                const orderA = staffOrder[a.staff_id] || 999; 
                const orderB = staffOrder[b.staff_id] || 999; 
                return orderA - orderB;
            });
            
            remainingCells.forEach((cell, index) => {
                if (todayReservations[index]) {
                    const reservation = todayReservations[index];
                    const paid = reservation.paid;
                    const startTime = reservation.start_time;
                    const duration = reservation.duration;
                    
                    if (paid) {
                        cell.textContent = '-';
                        cell.style.color = '#10b981';
                        cell.style.fontWeight = 'bold';
                    } else if (startTime) {
                        const remaining = calculateRemainingTime(startTime, duration, reservation.date);
                        
                        if (remaining === -1) {
                            cell.textContent = '-';
                            cell.style.color = '#6b7280';
                        } else if (remaining === 0) {
                            // 미래 날짜이거나 아직 시작되지 않은 경우
                            cell.textContent = '-';
                            cell.style.color = '#6b7280';
                        } else {
                            cell.textContent = `${remaining}min`;
                            
                            if (remaining <= 10) {
                                cell.style.color = '#ef4444';
                            } else if (remaining <= 30) {
                                cell.style.color = '#f59e0b';
                            } else {
                                cell.style.color = '#10b981';
                            }
                        }
                    } else {
                        cell.textContent = '-';
                        cell.style.color = '#6b7280';
                    }
                }
            });
        }

        // 입금 관련 함수
        async function showPaymentModal(reservationId) {
            currentPaymentReservationId = reservationId;
            
            // 예약 및 입금 방식 데이터 로드 (DB 연동)
            const currentDate = document.getElementById('currentDate').value;
            const reservations = await getReservationsData(currentDate); 
            const reservation = reservations.find(r => r.id === reservationId);
            const paymentMethods = await getPaymentMethodsData();
            
            // 화폐 단위 로드 (임시로 localStorage에서 로드)
            const currency = JSON.parse(localStorage.getItem(getAdminKey('currency')) || '{"symbol":"","name":"원"}');

            document.getElementById('paymentTotalAmount').textContent = reservation.price.toLocaleString();
            document.getElementById('paymentCurrency').textContent = currency.symbol;
            document.getElementById('paymentEnteredCurrency').textContent = currency.symbol;
            
            const methodsContainer = document.getElementById('paymentMethods');
            methodsContainer.innerHTML = '';

            // DB에서 가져온 입금 방식을 사용
            paymentMethods.forEach(method => {
                const defaultValue = method.name === '현금' ? reservation.price : '';
                methodsContainer.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label class="w-20">${method.name}:</label>
                        <input type="number" id="payment_${method.id}" class="border rounded px-2 py-1 flex-1" value="${defaultValue}" onchange="updatePaymentTotal()" inputmode="numeric" pattern="[0-9]*">
                        <span>${currency.symbol}</span>
                    </div>
                `;
            });

            document.getElementById('paymentModal').style.display = 'block';
            updatePaymentTotal();
        }

        function updatePaymentTotal() {
             // 입금 방식 데이터 로드 (DB 연동)
            const paymentMethods = JSON.parse(localStorage.getItem(getAdminKey('paymentMethods')) || '[]'); // [TODO: DB에서 로드하는 로직으로 변경 필요]
            let total = 0;

            paymentMethods.forEach(method => {
                const input = document.getElementById(`payment_${method.id}`);
                if (input) {
                    total += parseInt(input.value) || 0;
                }
            });

            document.getElementById('paymentEnteredAmount').textContent = total.toLocaleString();
        }

        async function processPayment() {
            const currentDate = document.getElementById('currentDate').value;
            const reservations = await getReservationsData(currentDate); 
            const reservation = reservations.find(r => r.id === currentPaymentReservationId);
            const paymentMethods = await getPaymentMethodsData(); // DB 연동
            const enteredAmount = parseInt(document.getElementById('paymentEnteredAmount').textContent.replace(/,/g, ''));

            // QR TIP 금액 계산
            let qrTipAmount = 0;
            paymentMethods.forEach(method => {
                if (method.name === 'QR TIP') {
                    const input = document.getElementById(`payment_${method.id}`);
                    if (input) {
                        qrTipAmount += parseInt(input.value) || 0;
                    }
                }
            });

            // QR TIP을 제외한 금액이 예약 가격과 일치하는지 확인
            const amountExcludingTip = enteredAmount - qrTipAmount;
            if (amountExcludingTip !== reservation.price) {
                alert('QR TIP을 제외한 입력된 금액이 총 금액과 일치하지 않습니다.');
                return;
            }

            // 입금 방식별 상세 정보 저장
            const paymentDetails = {};
            paymentMethods.forEach(method => {
                const input = document.getElementById(`payment_${method.id}`);
                if (input && parseInt(input.value) > 0) {
                    paymentDetails[method.name] = parseInt(input.value);
                }
            });

            // DB 업데이트를 위한 데이터 준비
            const updateData = {
                paid: true,
                payment_details: paymentDetails // DB 컬럼명에 맞게 변경
            };

            const updatedReservation = await updateReservationInDB(currentPaymentReservationId, updateData);

            if (updatedReservation) {
                alert('입금이 완료되었습니다.');
                closePaymentModal();
                loadDashboard();
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').style.display = 'none';
            currentPaymentReservationId = null;
        }

        async function deleteReservation(id) {
            if (confirm('정말 삭제하시겠습니까?')) {
                const success = await deleteReservationFromDB(id);
                if (success) {
                    loadDashboard();
                }
            }
        }

        function editReservation(id) { 
            alert('예약 수정 기능은 추후 구현 예정입니다. (Supabase 연동 필요)'); 
        }

        // 폰트 관련 함수들
// ... (폰트 관련 함수들은 그대로 유지) ...

        // 언어 모달 관련 함수들
// ... (언어 모달 관련 함수들은 그대로 유지) ...

        // 관리 모달 관련 함수들
// ... (closeManagementModal 함수는 그대로 유지) ...

        // DB 관리 함수들
        function manageMenus() {
            alert('메뉴 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function manageStaff() {
            alert('직원 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function manageRooms() {
             alert('방 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function manageCustomers() {
            alert('고객 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function manageAdmins() {
            alert('관리자 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function manageCurrency() {
             alert('화폐 단위 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function managePaymentMethods() {
             alert('입금방식 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        function manageGuarantee() {
             alert('Guarantee 관리 기능은 Supabase 연동 작업 중입니다. 다음 단계에서 구현 예정입니다.');
            // [TODO: DB 연동 후 구현]
        }

        // 통계 관련 함수들
// ... (통계 관련 함수들은 임시로 localStorage 기반 로직을 유지하거나 DB 연동 후 수정 예정) ...
        
        // 순번 관리 관련 함수들
        function loadStaffOrder() {
            // [TODO: DB 연동 시 DB에서 로드하는 로직으로 변경 필요]
            const staff = JSON.parse(localStorage.getItem(getAdminKey('staff')) || '[]');
            const currentDate = document.getElementById('currentDate').value;
            const staffOrder = JSON.parse(localStorage.getItem(getDailyStaffOrderKey(currentDate)) || '{}');
            
            // 정직원과 단기고용 직원만 필터링
            const activeStaff = staff.filter(s => {
                const status = s.status || '정직원';
                return status === '정직원' || status === '단기고용';
            });
            
            const tableBody = document.getElementById('orderTable');
            tableBody.innerHTML = '';

            activeStaff.forEach(member => {
                const currentOrder = staffOrder[member.id] !== undefined ? staffOrder[member.id] : 1;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 p-2">${member.name}</td>
                    <td class="border border-gray-300 p-2">${member.status || '정직원'}</td>
                    <td class="border border-gray-300 p-2">
                        <select id="order_${member.id}" class="w-full border rounded px-2 py-1">
                            ${generateOrderOptions(currentOrder)}
                        </select>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function generateOrderOptions(selectedOrder) {
            let options = '';
            for (let i = 0; i <= 99; i++) {
                const selected = i === selectedOrder ? 'selected' : '';
                const label = i === 0 ? `${i} (휴가)` : i;
                options += `<option value="${i}" ${selected}>${label}</option>`;
            }
            return options;
        }

        function saveStaffOrder() {
             // [TODO: DB 연동 시 DB에 저장하는 로직으로 변경 필요]
            const staff = JSON.parse(localStorage.getItem(getAdminKey('staff')) || '[]');
            const activeStaff = staff.filter(s => {
                const status = s.status || '정직원';
                return status === '정직원' || status === '단기고용';
            });
            const currentDate = document.getElementById('currentDate').value;
            const staffOrder = {};

            activeStaff.forEach(member => {
                const orderSelect = document.getElementById(`order_${member.id}`);
                if (orderSelect) {
                    staffOrder[member.id] = parseInt(orderSelect.value);
                }
            });

            localStorage.setItem(getDailyStaffOrderKey(currentDate), JSON.stringify(staffOrder));
            alert(`${currentDate} 날짜의 순번이 저장되었습니다.`);
            loadReservationData(); // 예약 화면 업데이트
            loadStaffOrder(); // 순번 화면 새로고침
        }

// ... (DB 관리 세부 기능 함수들은 추후 DB 연동 후 수정 예정이므로 alert로 대체) ...
        
        // 앱 초기화
        initializeApp();
        updateTranslations();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'998ccaa3d1a664f5',t:'MTc2MjE4MjU2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
