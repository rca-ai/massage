<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>마사지샵 관리 시스템</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.0/dist/supabase.min.js"></script>
  <style>
    /* 간단한 모달 스타일 */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); align-items:center; justify-content:center; z-index:50; }
    .modal .modal-content { background:#fff; padding:20px; border-radius:8px; width:90%; max-width:720px; }
    .required-label::after { content:" *"; color:#dc2626; }
    /* 기타 */
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Helvetica Neue", Arial; }
    .selection-grid { display:flex; flex-wrap:wrap; gap:8px; }
    .selected-staff-info { border:1px solid #e5e7eb; padding:8px; border-radius:6px; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 로그인 화면 -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
   <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
    <div class="text-center mb-8">
     <h1 class="text-3xl font-bold text-gray-800 mb-2" data-translate="title">마사지샵 관리 시스템</h1>
     <div class="w-20 h-1 bg-blue-500 mx-auto"></div>
    </div><!-- 언어 선택 -->
    <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">언어 선택 / Language / ภาษา / Ngôn ngữ</label>
     <div class="grid grid-cols-4 gap-2">
      <button onclick="setLanguage('ko')" class="bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600" id="langKo">한국어</button>
      <button onclick="setLanguage('en')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langEn">English</button>
      <button onclick="setLanguage('th')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langTh">ไทย</button>
      <button onclick="setLanguage('vi')" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" id="langVi">Tiếng Việt</button>
     </div>
    </div>
    <div class="space-y-4">
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="username">아이디</label>
      <input type="text" id="loginUsername" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="usernameInput">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="password">비밀번호</label>
      <input type="password" id="loginPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" data-translate-placeholder="passwordInput">
     </div>
     <button id="btnLogin" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200" data-translate="login">로그인</button>

     <div class="text-center text-sm text-gray-600 mt-2">
      <button id="btnShowGoogleModal" class="text-blue-600 underline">구글 로그인</button>
     </div>
    </div>
   </div>
  </div>

  <!-- 메인 화면 -->
  <div id="mainScreen" class="container mx-auto p-6" style="display: none;">
   <!-- 헤더 -->
   <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
     <div>
      <h1 class="text-3xl font-bold text-gray-800" data-translate="title">마사지 관리 프로그램</h1>
      <p id="shopName" class="text-lg text-gray-600 mt-1"></p>
     </div>
     <div class="flex gap-2">
      <button onclick="showLanguageModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="changeLanguage">언어 변경</button>
      <button onclick="showFontModal()" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600" data-translate="changeFont">폰트 변경</button>
      <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" data-translate="logout">로그아웃</button>
     </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
     <div class="text-center">
      <label class="block text-sm font-medium mb-2" data-translate="todayDate">오늘 날짜</label>
      <div class="flex gap-2">
       <input type="date" id="currentDate" class="border rounded px-3 py-2 flex-1">
       <button onclick="confirmDateChange()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="confirmDate">확인</button>
      </div>
     </div>
     <div class="text-center">
      <label class="block text-sm font-medium mb-2" data-translate="currentTime">현재 시간</label>
      <div id="currentTime" class="text-xl font-bold text-blue-600"></div>
     </div>
    </div>
   </div>

   <!-- 메뉴 버튼들 -->
   <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
    <button onclick="showDashboard()" class="bg-blue-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-blue-600" data-translate="dashboard">현황판</button>
    <button onclick="showOrder()" class="bg-indigo-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-indigo-600" data-translate="order">순번</button>
    <button onclick="showReservation()" class="bg-green-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-green-600" data-translate="reservation">예약</button>
    <button onclick="showStatistics()" class="bg-purple-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-purple-600" data-translate="statistics">통계</button>
    <button onclick="showDBManagement()" class="bg-orange-500 text-white py-4 px-6 rounded-lg text-lg hover:bg-orange-600" data-translate="dbManagement">DB 관리</button>
   </div>

   <!-- 순번 섹션 -->
   <div id="orderSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="orderManagement">순번 관리</h2>
    <div class="mb-4">
     <button onclick="saveStaffOrder()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="saveOrder">순번 저장</button>
    </div>
    <div class="overflow-x-auto">
     <table class="w-full border-collapse border border-gray-300">
      <thead>
       <tr class="bg-gray-100">
        <th class="border border-gray-300 p-2" data-translate="staffName">직원명</th>
        <th class="border border-gray-300 p-2" data-translate="status">상태</th>
        <th class="border border-gray-300 p-2" data-translate="orderNumber">순번</th>
       </tr>
      </thead>
      <tbody id="orderTable"></tbody>
     </table>
    </div>
    <div class="mt-4 text-sm text-gray-600" data-translate="orderZeroVacationNote">* 순번 0은 휴가로 처리됩니다.</div>
   </div>

   <!-- 현황판 -->
   <div id="dashboardSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="dashboard">현황판</h2>
    <div class="overflow-x-auto">
     <table class="w-full border-collapse border border-gray-300">
      <thead>
       <tr class="bg-gray-100">
        <th class="border border-gray-300 p-2" data-translate="staff">직원명</th>
        <th class="border border-gray-300 p-2" data-translate="menu">메뉴</th>
        <th class="border border-gray-300 p-2" data-translate="duration">시간</th>
        <th class="border border-gray-300 p-2" data-translate="startTime">시작시간</th>
        <th class="border border-gray-300 p-2" data-translate="endTime">끝시간</th>
        <th class="border border-gray-300 p-2" data-translate="remainingTime">남은시간</th>
        <th class="border border-gray-300 p-2" data-translate="price">가격</th>
        <th class="border border-gray-300 p-2" data-translate="commission">커미션</th>
        <th class="border border-gray-300 p-2" data-translate="roomNumber">방번호</th>
        <th class="border border-gray-300 p-2" data-translate="actions">작업</th>
       </tr>
      </thead>
      <tbody id="dashboardTable"></tbody>
     </table>
    </div>
   </div>

   <!-- 예약 섹션 -->
   <div id="reservationSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="reservation">예약</h2>
    <div class="mb-6">
     <label class="block text-sm font-medium mb-2 required-label" data-translate="selectStaff">직원 선택</label>
     <div id="staffSelectionContainer">
      <div id="staffSelection" class="selection-grid"></div>
      <div id="selectedStaffInfo" class="selected-staff-info" style="display: none;">
       <div class="flex justify-between items-center">
        <div>
         <h4 class="font-bold text-lg">선택된 직원: <span id="selectedStaffName"></span></h4>
         <p class="text-sm text-gray-600">순번: <span id="selectedStaffOrder"></span></p>
        </div>
        <button onclick="changeStaff()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">직원 변경</button>
       </div>
      </div>
     </div>
    </div>

    <div id="menuListContainer" style="display: none;">
     <div class="flex justify-between items-center mb-4">
      <label class="block text-sm font-medium required-label">메뉴 목록</label>
      <button onclick="addMenuRow()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center gap-2">
       <span class="text-lg">+</span> 메뉴 추가
      </button>
     </div>
     <div id="menuRows"></div>
     <div class="mt-6 p-4 bg-gray-100 rounded">
      <div class="grid grid-cols-2 gap-4">
       <div><strong data-translate="totalPrice">총 가격:</strong> <span id="totalPrice">0</span><span id="totalPriceCurrency"></span></div>
       <div><strong data-translate="totalCommission">총 커미션:</strong> <span id="totalCommission">0</span><span id="totalCommissionCurrency"></span></div>
      </div>
     </div>

     <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div><label class="block text-sm font-medium mb-2" data-translate="startTime">시작 시간 (선택사항)</label>
       <input type="time" id="reservationStartTime" class="w-full border rounded px-3 py-2" onchange="updateAllMenuTimes()"></div>
      <div><label class="block text-sm font-medium mb-2" data-translate="roomNumber">방번호 (선택사항)</label>
       <select id="reservationRoom" class="w-full border rounded px-3 py-2"><option value="" data-translate="selectRoom">방 선택</option></select></div>
      <div><label class="block text-sm font-medium mb-2" data-translate="customerName">고객명 (선택사항)</label>
       <input type="text" id="reservationCustomer" class="w-full border rounded px-3 py-2" data-translate-placeholder="enterCustomerName"></div>
     </div>

     <div id="menuTimeSettings" class="mt-6" style="display: none;">
      <h4 class="font-bold mb-3">메뉴별 시간 설정</h4>
      <div id="menuTimeList" class="space-y-3"></div>
     </div>

     <button onclick="addReservation()" class="mt-6 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600" data-translate="addReservation">예약 추가</button>
    </div>
   </div>

   <!-- 통계 섹션 -->
   <div id="statisticsSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="statistics">통계</h2>
    <div class="mb-4 flex gap-4 flex-wrap">
     <button onclick="showDailyStats()" id="dailyStatsBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" data-translate="daily">일간</button>
     <button onclick="showWeeklyStats()" id="weeklyStatsBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400" data-translate="weekly">주간</button>
     <button onclick="showMonthlyStats()" id="monthlyStatsBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400" data-translate="monthly">월간</button>
     <button onclick="showMenuSales()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600" data-translate="monthlyMenuSales">월간 메뉴 매출</button>
     <button onclick="showMonthlySalesChart()" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600" data-translate="monthlySalesChart">월간 매출 그래프</button>
     <button onclick="downloadExcel()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700" data-translate="download">다운로드</button>
    </div>

    <div class="mb-6 p-4 bg-gray-50 rounded">
     <div id="dailyDateSelection" class="mb-4">
      <label class="block text-sm font-medium mb-2" data-translate="selectDate">날짜 선택</label>
      <input type="date" id="statsDate" class="border rounded px-3 py-2" onchange="updateStats()">
     </div>

     <div id="rangeDateSelection" class="grid grid-cols-1 md:grid-cols-2 gap-4" style="display: none;">
      <div><label class="block text-sm font-medium mb-2" data-translate="startDate">시작 날짜</label><input type="date" id="statsStartDate" class="w-full border rounded px-3 py-2" onchange="autoSetEndDate()"></div>
      <div><label class="block text-sm font-medium mb-2" data-translate="endDate">끝 날짜</label><input type="date" id="statsEndDate" class="w-full border rounded px-3 py-2" onchange="updateStats()"></div>
     </div>

     <div id="quickDateSelection" class="mt-3 flex gap-2 flex-wrap" style="display: none;">
      <button onclick="setThisWeek()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200" data-translate="thisWeek">이번 주</button>
      <button onclick="setLastWeek()" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200" data-translate="lastWeek">지난 주</button>
      <button onclick="setThisMonth()" class="bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200" data-translate="thisMonth">이번 달</button>
      <button onclick="setLastMonth()" class="bg-green-100 text-green-700 px-3 py-1 rounded text-sm hover:bg-green-200" data-translate="lastMonth">지난 달</button>
     </div>
    </div>

    <div id="chartContainer" class="mb-6" style="display: none;">
     <canvas id="statsChart" width="800" height="400"></canvas>
    </div>

    <div class="mb-6">
     <h3 class="text-lg font-bold mb-2" data-translate="staffStatisticsTitle">직원별 통계</h3>
     <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300">
       <thead>
        <tr class="bg-gray-100">
         <th class="border border-gray-300 p-2" data-translate="staff">마사지사</th>
         <th class="border border-gray-300 p-2" data-translate="totalPrice">총 가격</th>
         <th class="border border-gray-300 p-2" data-translate="totalCommission">총 커미션</th>
        </tr>
       </thead>
       <tbody id="statsTable"></tbody>
      </table>
     </div>
    </div>

    <div class="mb-6">
     <h3 class="text-lg font-bold mb-2" data-translate="paymentMethodStatisticsTitle">입금방식별 통계</h3>
     <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300">
       <thead>
        <tr class="bg-gray-100">
         <th class="border border-gray-300 p-2" data-translate="paymentMethodColumn">입금방식</th>
         <th class="border border-gray-300 p-2" data-translate="amountColumn">금액</th>
        </tr>
       </thead>
       <tbody id="paymentStatsTable"></tbody>
      </table>
     </div>
    </div>

    <div class="p-4 bg-gray-100 rounded">
     <div class="grid grid-cols-3 gap-4">
      <div><strong data-translate="grandTotal">총 금액(QR팁 제외):</strong> <span id="grandTotalPrice">0</span><span id="grandTotalCurrency"></span></div>
      <div><strong data-translate="grandTotalCommission">총 커미션:</strong> <span id="grandTotalCommission">0</span><span id="grandTotalCommissionCurrency"></span></div>
      <div><strong data-translate="profit">수익:</strong> <span id="totalProfit">0</span><span id="totalProfitCurrency"></span></div>
     </div>
    </div>
   </div>

   <!-- DB 관리 섹션 -->
   <div id="dbManagementSection" class="bg-white rounded-lg shadow-md p-6" style="display: none;">
    <h2 class="text-2xl font-bold mb-4" data-translate="dbManagement">DB 관리</h2>
    <div class="mb-6 p-4 bg-gray-100 rounded">
     <h3 class="text-lg font-bold mb-2" data-translate="dataBackupRestoreTitle">데이터 백업 및 복원</h3>
     <div class="grid grid-cols-2 gap-4">
      <div>
       <h4 class="font-semibold mb-2" data-translate="backupButton">백업</h4>
       <div class="flex gap-2 flex-wrap">
        <button onclick="showLocalBackupDialog()" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 text-sm" data-translate="localBackupButton">로컬 백업</button>
        <button onclick="showGoogleBackupDialog()" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 text-sm" data-translate="googleBackupButton">구글 백업</button>
       </div>
      </div>
      <div>
       <h4 class="font-semibold mb-2" data-translate="restoreButton">복원</h4>
       <div class="flex gap-2 flex-wrap">
        <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreData(event)">
        <button onclick="showLocalRestoreDialog()" class="bg-orange-600 text-white px-3 py-2 rounded hover:bg-orange-700 text-sm" data-translate="localRestoreButton">로컬 복원</button>
        <button onclick="showGoogleRestoreDialog()" class="bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700 text-sm" data-translate="googleRestoreButton">구글 복원</button>
       </div>
      </div>
     </div>
     <div class="mt-4"><button onclick="exportAllDataExcel()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700" data-translate="exportAllDataButton">전체 데이터 엑셀 내보내기</button></div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
     <button onclick="manageMenus()" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600" data-translate="menuManagement">메뉴 관리</button>
     <button onclick="manageStaff()" class="bg-green-500 text-white py-3 px-4 rounded hover:bg-green-600" data-translate="staffManagement">직원 관리</button>
     <button onclick="manageRooms()" class="bg-purple-500 text-white py-3 px-4 rounded hover:bg-purple-600" data-translate="roomManagement">방 관리</button>
     <button onclick="manageCustomers()" class="bg-orange-500 text-white py-3 px-4 rounded hover:bg-orange-600" data-translate="customerManagement">고객 관리</button>
     <button onclick="manageCurrency()" class="bg-pink-500 text-white py-3 px-4 rounded hover:bg-pink-600" data-translate="currencyManagement">화폐 단위</button>
     <button onclick="managePaymentMethods()" class="bg-yellow-500 text-white py-3 px-4 rounded hover:bg-yellow-600" data-translate="paymentMethodManagement">입금방식 관리</button>
     <button onclick="manageGuarantee()" class="bg-teal-500 text-white py-3 px-4 rounded hover:bg-teal-600">Guarantee 관리</button>
     <div id="superAdminButtons" style="display: none;"><button onclick="manageAdmins()" class="bg-red-500 text-white py-3 px-4 rounded hover:bg-red-600" data-translate="adminManagement">관리자 관리</button></div>
    </div>
   </div>
  </div>

  <!-- Payment Modal (간단 구현) -->
  <div id="paymentModal" class="modal"><div class="modal-content">
    <h3 class="text-xl font-bold mb-4" data-translate="payment">입금 처리</h3>
    <div id="paymentMethods" class="space-y-4 mb-4"></div>
    <div class="mb-4"><strong data-translate="totalAmount">총 금액:</strong> <span id="paymentTotalAmount">0</span><span id="paymentCurrency"></span></div>
    <div class="mb-4"><strong data-translate="enteredAmount">입력된 금액:</strong> <span id="paymentEnteredAmount">0</span><span id="paymentEnteredCurrency"></span></div>
    <div class="flex gap-2"><button onclick="processPayment()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-translate="confirm">확인</button> <button onclick="closePaymentModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="cancel">취소</button></div>
  </div></div>

  <!-- Management Modal -->
  <div id="managementModal" class="modal"><div class="modal-content">
    <h3 id="managementTitle" class="text-xl font-bold mb-4"></h3>
    <div id="managementContent"></div>
    <button onclick="closeManagementModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="close">닫기</button>
  </div></div>

  <!-- Language Modal -->
  <div id="languageModal" class="modal"><div class="modal-content">
    <h3 class="text-xl font-bold mb-4">언어 선택 / Language / ภาษา / Ngôn ngữ</h3>
    <div class="grid grid-cols-2 gap-4">
      <button onclick="setLanguageAndClose('ko')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">한국어</button>
      <button onclick="setLanguageAndClose('en')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">English</button>
      <button onclick="setLanguageAndClose('th')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">ไทย</button>
      <button onclick="setLanguageAndClose('vi')" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600">Tiếng Việt</button>
    </div>
    <button onclick="closeLanguageModal()" class="mt-4 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">닫기</button>
  </div></div>

  <!-- Font Modal -->
  <div id="fontModal" class="modal"><div class="modal-content">
    <h3 class="text-xl font-bold mb-4" data-translate="fontSelection">폰트 선택</h3>
    <div class="mb-6 p-4 bg-gray-50 rounded">
     <h4 class="font-bold mb-3" data-translate="fontSize">폰트 크기</h4>
     <div class="grid grid-cols-5 gap-2">
      <button onclick="setFontSize('small')" id="fontSizeSmall" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeSmall">작게</button>
      <button onclick="setFontSize('normal')" id="fontSizeNormal" class="bg-blue-500 text-white py-2 px-3 rounded text-sm hover:bg-blue-600" data-translate="fontSizeNormal">보통</button>
      <button onclick="setFontSize('large')" id="fontSizeLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeLarge">크게</button>
      <button onclick="setFontSize('xlarge')" id="fontSizeXLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeXLarge">매우 크게</button>
      <button onclick="setFontSize('xxlarge')" id="fontSizeXXLarge" class="bg-gray-300 text-gray-700 py-2 px-3 rounded text-sm hover:bg-gray-400" data-translate="fontSizeXXLarge">최대</button>
     </div>
     <div class="mt-2 text-sm text-gray-600"><span id="fontSizePreview">미리보기 텍스트 - Preview Text - ตัวอย่างข้อความ - Văn bản xem trước</span></div>
    </div>
    <div class="mb-4">
     <h4 class="font-bold mb-3" data-translate="fontFamily">폰트 종류</h4>
     <div class="grid grid-cols-1 gap-3">
      <button onclick="setFontFamily('Arial')" id="fontFamilyArial" class="bg-blue-500 text-white py-3 px-4 rounded hover:bg-blue-600" style="font-family: Arial;">Arial (기본)</button>
      <button onclick="setFontFamily('Noto Sans KR')" id="fontFamilyNotoKR" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans KR', sans-serif;">Noto Sans KR (한글 최적화)</button>
      <button onclick="setFontFamily('Malgun Gothic')" id="fontFamilyMalgun" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Malgun Gothic', sans-serif;">맑은 고딕</button>
      <button onclick="setFontFamily('Nanum Gothic')" id="fontFamilyNanum" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Nanum Gothic', sans-serif;">나눔고딕</button>
      <button onclick="setFontFamily('Roboto')" id="fontFamilyRoboto" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Roboto', sans-serif;">Roboto (영문 최적화)</button>
      <button onclick="setFontFamily('Noto Sans Thai')" id="fontFamilyThai" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans Thai', sans-serif;">Noto Sans Thai (태국어)</button>
      <button onclick="setFontFamily('Noto Sans Vietnamese')" id="fontFamilyVietnamese" class="bg-gray-300 text-gray-700 py-3 px-4 rounded hover:bg-gray-400" style="font-family: 'Noto Sans Vietnamese', sans-serif;">Noto Sans Vietnamese (베트남어)</button>
     </div>
    </div>
    <div class="flex gap-2">
     <button onclick="applyFontSettings()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600" data-translate="apply">적용</button>
     <button onclick="closeFontModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" data-translate="close">닫기</button>
    </div>
  </div></div>

  <!-- Google Login Modal (UI only) -->
  <div id="google
  <script>
    // =========================================================================
    // 1. 설정: Supabase 및 상수
    // =========================================================================
    const SUPABASE_URL = "https://lmjtjonlvpqcwdzisijd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtanRqb25sdnBxY3dkemlzaWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjY1NDksImV4cCI6MjA3ODcwMjU0OX0.HmfZaxAnaVEEHfLxnlUHxR-PAjrUnFMVWs839xJmKfw";
    const THUMBNAIL_EDGE_FUNCTION_URL = "https://lmjtjonlvpqcwdzisijd.functions.supabase.co/employee-thumbnail-generator";
    const STORAGE_BUCKET = "employee-photos-thumbs";

    // 관리자용: 실행 권장 SQL (복사해서 SQL Editor에서 실행)
    const REQUIRED_SQL = `
-- 확장
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- employees
CREATE TABLE IF NOT EXISTS employees (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  full_name text NOT NULL,
  photo_url text,
  thumbnail_url text,
  is_active boolean DEFAULT true
);

-- services
CREATE TABLE IF NOT EXISTS services (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  duration_minutes int NOT NULL,
  price numeric(10,2) NOT NULL,
  commission numeric(10,2) NOT NULL
);

-- day_orders
CREATE TABLE IF NOT EXISTS day_orders (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  day date NOT NULL,
  employee_id uuid REFERENCES employees(id),
  position int NOT NULL
);

-- bookings
CREATE TABLE IF NOT EXISTS bookings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  day date NOT NULL,
  employee_id uuid REFERENCES employees(id),
  start_at timestamptz NOT NULL,
  end_at timestamptz NOT NULL,
  items jsonb NOT NULL,
  total_price numeric(10,2) NOT NULL,
  total_commission numeric(10,2) NOT NULL,
  created_by uuid
);

-- employee_photos (optional)
CREATE TABLE IF NOT EXISTS employee_photos (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  employee_id uuid REFERENCES employees(id),
  original_url text,
  thumbnail_url text,
  uploaded_at timestamptz DEFAULT now()
);
`.trim();

    // =========================================================================
    // 2. DOMContentLoaded 안에서 초기화 (DOM 안전)
    // =========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Supabase 클라이언트 초기화
      const supabase = supabaseJs.createClient ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // DOM refs
      const authArea = document.getElementById('auth-area');
      const employeesList = document.getElementById('employees-list');
      const dashboardArea = document.getElementById('dashboard-area');
      const bookingRoot = document.getElementById('booking-root');
      const statsArea = document.getElementById('stats-area');
      const adminArea = document.getElementById('admin-area');
      const initResult = document.getElementById('init-result');
      const selectedDateInput = document.getElementById('selected-date');
      const btnShowSql = document.getElementById('btn-show-sql');
      const btnCreateSample = document.getElementById('btn-create-sample');

      // 기본 날짜 설정
      if (selectedDateInput) selectedDateInput.value = new Date().toISOString().slice(0,10);

      // ----------------------
      // Auth 렌더링 및 처리
      // ----------------------
      async function renderAuth() {
        try {
          const { data } = await supabase.auth.getUser();
          const user = data?.user ?? null;
          authArea.innerHTML = '';
          if (!user) {
            const form = document.createElement('div');
            form.innerHTML = `
              <input id="email" placeholder="이메일" class="p-1 border rounded" />
              <input id="password" type="password" placeholder="비밀번호" class="p-1 border rounded" />
              <button id="btn-login" class="badge">로그인</button>
            `;
            authArea.appendChild(form);
            form.querySelector('#btn-login').addEventListener('click', async () => {
              const email = form.querySelector('#email').value;
              const password = form.querySelector('#password').value;
              if (!email || !password) return alert('이메일과 비밀번호를 입력하세요');
              const { error } = await supabase.auth.signInWithPassword({ email, password });
              if (error) return alert('로그인 오류: ' + error.message);
              await renderAuth();
              await loadEmployees();
              loadDayDashboard();
            });
          } else {
            const div = document.createElement('div');
            div.innerHTML = `<span>${user.email}</span> <button id="btn-logout" class="badge">로그아웃</button>`;
            authArea.appendChild(div);
            div.querySelector('#btn-logout').addEventListener('click', async () => {
              await supabase.auth.signOut();
              await renderAuth();
            });
            // 간단한 수퍼유저 판단: 이메일이 admin@ 로 시작하면 관리자 영역 노출
            if (user.email && user.email.startsWith('admin@')) {
              adminArea.style.display = 'block';
            } else {
              adminArea.style.display = 'none';
            }
          }
        } catch (err) {
          authArea.innerText = 'Auth 초기화 중 오류: ' + err.message;
        }
      }

      // ----------------------
      // Load employees
      // ----------------------
      async function loadEmployees() {
        if (!employeesList) return;
        employeesList.innerText = '로딩중...';
        const { data, error } = await supabase.from('employees').select('*').order('full_name');
        if (error) {
          employeesList.innerText = '로딩 오류: ' + error.message;
          return;
        }
        employeesList.innerHTML = '';
        data.forEach(emp => {
          const el = document.createElement('div');
          el.className = 'employee-item';
          el.innerHTML = `
            <img class="thumb" src="${escapeHtml(emp.thumbnail_url || emp.photo_url || 'https://via.placeholder.com/48')}" alt="thumb" />
            <div style="flex:1;">
              <div><strong>${escapeHtml(emp.full_name)}</strong></div>
              <div class="muted" style="font-size:12px;">${escapeHtml(emp.id)}</div>
            </div>
            <div>
              <button class="select-emp badge" data-id="${emp.id}">선택</button>
              <button class="upload-photo badge" data-id="${emp.id}">사진 업로드</button>
            </div>
          `;
          employeesList.appendChild(el);
        });
        // events
        document.querySelectorAll('.select-emp').forEach(btn => btn.addEventListener('click', (e) => openBookingForEmployee(e.currentTarget.dataset.id)));
        document.querySelectorAll('.upload-photo').forEach(btn => btn.addEventListener('click', (e) => openPhotoUploader(e.currentTarget.dataset.id)));
      }

      // ----------------------
      // Booking UI (간단 플레이스홀더)
      // ----------------------
      function openBookingForEmployee(employeeId) {
        if (!bookingRoot) return;
        bookingRoot.innerHTML = `<div>직원 선택: ${escapeHtml(employeeId)}<div style="margin-top:8px;"><button id="btn-create-booking" class="badge">샘플 예약 생성 (로컬 시뮬)</button></div></div>`;
        const btn = document.getElementById('btn-create-booking');
        if (btn) btn.addEventListener('click', () => alert('샘플 예약 생성은 서버/DB에서 처리하세요.'));
      }

      // Upload photo handler (간단 안내)
      function openPhotoUploader(employeeId) {
        alert('사진 업로드는 Storage 및 Edge Function을 통해 처리하세요. 직원 ID: ' + employeeId);
      }

      // ----------------------
      // Dashboard / Stats placeholders
      // ----------------------
      async function loadDayDashboard() {
        const sel = document.getElementById('selected-date');
        const day = sel ? sel.value : new Date().toISOString().slice(0,10);
        dashboardArea.innerText = `선택된 날짜: ${day} — 현황 로딩 중... (실제 쿼리 구현 필요)`;
        // 실제 구현: supabase.from('bookings').select(...) 등으로 데이터 조회 후 렌더
      }

      document.getElementById('load-stats')?.addEventListener('click', async () => {
        statsArea.innerText = '통계 로딩 중... (구현 필요)';
      });

      document.getElementById('btn-create-sample')?.addEventListener('click', () => {
        if (!confirm('샘플 데이터 생성은 관리자 전용이며, SQL Editor에서 실행하시길 권장합니다. SQL을 복사하시겠습니까?')) return;
        // 복사하여 관리자에게 제공하게 함
        navigator.clipboard?.writeText(REQUIRED_SQL).then(() => {
          initResult.innerText = '관리자용 SQL이 클립보드에 복사되었습니다. SQL Editor에 붙여넣어 실행하세요.';
        }).catch(() => {
          initResult.innerText = '클립보드 복사 실패 — 아래 버튼으로 SQL을 보세요.';
        });
      });

      // 버튼: SQL 보기
      btnShowSql?.addEventListener('click', () => {
        const el = document.getElementById('sql-view');
        el.textContent = REQUIRED_SQL;
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
      });

      // 단순 대시보드 로드 버튼
      document.getElementById('btn-load-dashboard')?.addEventListener('click', loadDayDashboard);

      // 초기 렌더
      await renderAuth();
      await loadEmployees();
      loadDayDashboard();

      // ----------------------
      // 유틸리티
      // ----------------------
      function escapeHtml(str) {
        if (!str && str !== 0) return '';
        return String(str)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      // Expose some functions for debugging in console (optional)
      window.app = {
        supabase,
        loadEmployees,
        loadDayDashboard,
        REQUIRED_SQL
      };
    });
  </script>
</head>
<body>
  <h1>마사지샵 관리 시스템</h1>

  <!-- 인증 -->
  <section id="auth-area" class="col"></section>

  <!-- 상단: 날짜 선택 및 현황 -->
  <section class="col" id="top-col">
    <label>날짜:
      <input id="selected-date" type="date" />
    </label>
    <button id="btn-load-dashboard" class="badge">현황 불러오기</button>
    <hr/>
    <h3>현황판</h3>
    <div id="dashboard-area" class="muted">날짜를 선택하고 '현황 불러오기'를 누르세요.</div>
  </section>

  <!-- 중간: 직원 목록 및 예약 패널 -->
  <section class="col" id="middle-col">
    <h3>직원 목록 (선택)</h3>
    <div id="employees-list" class="muted">로딩중...</div>

    <hr/>
    <h3>예약 / 선택 항목</h3>
    <div id="booking-panel">
      <div id="booking-root">직원을 선택하면 예약 UI가 표시됩니다.</div>
    </div>
  </section>

  <!-- 우측: 통계 및 관리자 -->
  <section class="col" id="right-col">
    <h3>통계</h3>
    <label>범위:
      <select id="stats-range">
        <option value="day">일별</option>
        <option value="week">주별</option>
        <option value="month">월별</option>
      </select>
    </label>
    <button id="load-stats" class="badge">불러오기</button>
    <div id="stats-area" class="muted" style="margin-top:8px;">통계가 여기에 표시됩니다.</div>

    <hr/>
    <div id="admin-area" style="display:none;">
      <h3>관리 (수퍼유저)</h3>
      <div id="db-admin" class="muted">초기화 및 SQL 보기</div>
      <div style="margin-top:8px;">
        <button id="btn-show-sql" class="badge">필요 SQL 보기</button>
        <button id="btn-create-sample" class="badge">샘플 데이터 생성</button>
        <div id="init-result" style="margin-top:8px;"></div>
      </div>
    </div>
  </section>

  <!-- 관리자용: SQL 표시 영역 (기본 숨김) -->
  <section class="col" id="sql-section" style="display:block;">
    <pre id="sql-view" style="display:none; white-space:pre-wrap;"></pre>
  </section>
</body>
</html>
